<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Картотека площадок</title>

  <!-- firebaseConfig -->
  <script>
    window.__FIREBASE_CONFIG__ = {
      apiKey: "AIzaSyANblr6MInsVbY9LnN3OUHNA5Ri2ttPHCo",
      authDomain: "ai-event-bot.firebaseapp.com",
      databaseURL: "https://ai-event-bot-default-rtdb.firebaseio.com",
      projectId: "ai-event-bot",
      storageBucket: "ai-event-bot.firebasestorage.app",
      messagingSenderId: "884896771261",
      appId: "1:884896771261:web:b60d950938a924a71a5bd4",
      measurementId: "G-4H9BVWN184"
    };
    window.__FIREBASE_COLLECTIONS__ = { 
      venues: "venues", 
      shortlists: "shortlists",
      singers: "singers",
      singer_shortlists: "singer_shortlists",
      cars: "car_providers",
      car_shortlists: "car_shortlists"
    };
  </script>

  <!-- БАЗОВЫЕ СТИЛИ СТРАНИЦЫ -->
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --txt:#0f172a; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 4px;font-size:28px}
    .sub{color:var(--muted);margin:0 0 16px}
    .status{margin:8px 0 16px;font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 1px 3px rgb(0 0 0 / 0.05)}
    .img{height:180px;background:#eee;display:block;width:100%;object-fit:cover}
    .body{padding:14px}
    .row{display:flex;justify-content:space-between;gap:12px}
    .loc{color:var(--muted);font-size:14px}
    .p{margin:8px 0 0;color:#334155;font-size:14px;line-height:1.35}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--border);background:white;border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#fafafa}
    .footer{margin:24px 0 12px;color:var(--muted);font-size:12px;text-align:center}
    .note{font-size:12px;color:var(--muted)}
    .inp{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .catalog-tab{border:none;background:transparent;padding:12px 20px;font-size:15px;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s}
    .catalog-tab:hover{background:#f1f5f9}
    .catalog-tab.active{border-bottom-color:#2563eb;color:#2563eb;font-weight:600}
    @media (max-width:900px){ #filters{grid-template-columns:1fr 1fr; } }
    a.btn, a.btn:link, a.btn:visited, a.btn:hover, a.btn:active {
      text-decoration: none !important;
    }
  </style>

  <!-- СТИЛИ МОДАЛКИ ГАЛЕРЕИ -->
  <style>
    .gallery-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:50}
    .gallery-backdrop.show{display:flex}
    .gallery-wrap{max-width:min(1200px,96vw);max-height:90vh;display:flex;flex-direction:column;gap:10px}
    .gallery-stage{position:relative;background:#000;border-radius:12px;overflow:hidden}
    .gallery-img{max-width:96vw;max-height:70vh;display:block;margin:0 auto}
    .gallery-close,.gallery-prev,.gallery-next{
      position:absolute;top:10px;border:none;background:rgba(255,255,255,.15);color:#fff;
      width:40px;height:40px;border-radius:999px;cursor:pointer;font-size:18px;backdrop-filter:blur(2px)
    }
    .gallery-close{right:10px}
    .gallery-prev{left:10px;top:50%;transform:translateY(-50%)}
    .gallery-next{right:10px;top:50%;transform:translateY(-50%)}
    .gallery-strip{display:flex;gap:8px;overflow-x:auto;padding:6px;background:#0b0b0b;border-radius:12px}
    .gallery-thumb{width:80px;height:60px;object-fit:cover;border-radius:8px;opacity:.6;border:2px solid transparent;cursor:pointer}
    .gallery-thumb.active{opacity:1;border-color:#fff}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:55;overflow-y:auto}
    .modal-backdrop.show{display:flex}
    .modal-content{background:#fff;border-radius:16px;max-width:min(700px,92vw);max-height:85vh;overflow-y:auto;padding:20px;position:relative}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px}
    .modal-title{font-size:20px;font-weight:700}
    .modal-close{border:none;background:#f1f5f9;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:18px}
    .modal-close:hover{background:#e2e8f0}
    .modal-body{font-size:14px;line-height:1.6}

    .select-dot{
      position:absolute;top:10px;left:10px;width:22px;height:22px;border-radius:999px;
      border:2px solid #fff;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:14px;cursor:pointer;user-select:none
    }
    .card.sel{outline:2px solid #2563eb}
    .card-wrap{position:relative}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="pageTitle">Картотека площадок</h1>
    
    <!-- Табы каталогов -->
    <div id="catalogTabs" style="display:flex;gap:8px;margin:12px 0 16px;border-bottom:2px solid var(--border);padding-bottom:0">
      <button class="catalog-tab active" data-catalog="venues">Площадки</button>
      <button class="catalog-tab" data-catalog="singers">Певцы</button>
      <button class="catalog-tab" data-catalog="cars">Автомобили</button>
    </div>

      <div id="toolbar" style="display:flex;gap:10px;align-items:center;margin:10px 0 16px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center;">
          <input id="modeToggle" type="checkbox">
          <span>Режим подбора</span>
        </label>
      
        <button id="genBtn" type="button" class="btn" disabled>Сгенерировать ссылку</button>
      
        <!-- Блок шаринга появляется после генерации -->
        <span id="shareBox" style="display:none;gap:8px;align-items:center;">
          <button id="copyBtn" type="button" class="btn">Скопировать</button>
          <a id="waBtn" class="btn" target="_blank" rel="noreferrer">WhatsApp</a>
          <a id="tgBtn" class="btn" target="_blank" rel="noreferrer">Telegram</a>
        </span>
      
        <span id="selCount" style="color:#6b7280;font-size:14px">Выбрано: 0</span>
      </div>

    <div id="filters" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;margin:8px 0 16px">
      <input id="fSearch" type="text" placeholder="Поиск: название, район, теги…" class="inp">
      <select id="fDistrict" class="inp"><option value="">Все районы</option></select>
      <input id="fCap" type="text" placeholder="Вместимость: 100-300" class="inp">
      <input id="fPrice" type="text" placeholder="Цена/гость: 20-100" class="inp">
    </div>

    <p class="sub">Список площадок с Firebase. Персональная ссылка поддерживает <code>?shortlist=SLUG&token=TOKEN</code>.</p>
    <div id="status" class="status"></div>
    <div id="grid" class="grid"></div>
    <div id="empty" style="display:none;color:#9ca3af;text-align:center;padding:40px 0">Ничего не найдено.</div>
    <div class="footer">Demo: данные из Firestore. Медиа отображаются по URL.</div>
  </div>
  
  <!-- Gallery modal -->
  <div id="gallery" class="gallery-backdrop" aria-hidden="true">
    <div class="gallery-wrap">
      <div class="gallery-stage">
        <img id="gallery-img" class="gallery-img" alt="">
        <button id="gallery-close" class="gallery-close" title="Закрыть">✕</button>
        <button id="gallery-prev"  class="gallery-prev"  title="Назад">❮</button>
        <button id="gallery-next"  class="gallery-next  title="Вперёд">❯</button>
      </div>
      <div id="gallery-strip" class="gallery-strip"></div>
    </div>
  </div>

  <div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
  background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:60">
    Скопировано
  </div>

  <!-- Repertoire Modal -->
  <div id="repertoireModal" class="modal-backdrop" onclick="if(event.target===this) closeRepertoireModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Репертуар</div>
        <button class="modal-close" onclick="closeRepertoireModal()">✕</button>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:12px">
        <input id="repSearch" type="text" placeholder="Поиск по названию..." class="inp" style="flex:1">
        <select id="repLangFilter" class="inp" style="width:140px">
          <option value="">Все языки</option>
        </select>
      </div>
      <div id="repertoireBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Packages Modal -->
  <div id="packagesModal" class="modal-backdrop" onclick="if(event.target===this) closePackagesModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Пакеты и тарифы</div>
        <button class="modal-close" onclick="closePackagesModal()">✕</button>
      </div>
      <div id="packagesBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Social Links Modal -->
  <div id="contactsModal" class="modal-backdrop" onclick="if(event.target===this) closeContactsModal()">
    <div class="modal-content" style="padding:0;max-width:min(600px,92vw);border-radius:20px">
      <div id="contactsBody" class="modal-body" style="padding:0;position:relative"></div>
    </div>
  </div>

  <!-- Car Details Modal -->
  <div id="carDetailsModal" class="modal-backdrop" onclick="if(event.target===this) closeCarDetailsModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Детали автомобилей</div>
        <button class="modal-close" onclick="closeCarDetailsModal()">✕</button>
      </div>
      <div id="carDetailsBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Link Config Modal -->
  <div id="linkConfig" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:70">
    <div style="background:#fff;border-radius:16px;max-width:520px;width:92vw;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:700;font-size:18px">Параметры ссылки</div>
        <button id="cfgClose" type="button" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer">✕</button>
      </div>
  
      <div style="display:grid;gap:12px">
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">Срок действия</span>
          <select id="cfgExpire" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px">
            <option value="7">7 дней</option>
            <option value="14">14 дней</option>
            <option value="30">30 дней</option>
            <option value="custom">Указать дату</option>
          </select>
        </label>
  
        <label id="cfgDateWrap" style="display:none;gap:6px">
          <span style="font-size:14px;color:#475569;margin-right:8px">Дата и время (локальные)</span>
          <input id="cfgDate" type="datetime-local" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
        </label>
  
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">Идентификатор (slug, латиница/цифры/дефисы)</span>
          <input id="cfgSlug" type="text" placeholder="например, ivanov-1016"
                 style="padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
        </label>
  
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">Заметка клиенту (необязательно)</span>
          <textarea id="cfgNote" rows="3" placeholder="Например: Под вашу дату есть спецусловия"
                    style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;resize:vertical"></textarea>
        </label>
      </div>
  
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
        <button id="cfgCancel" type="button" class="btn">Отмена</button>
        <button id="cfgCreate" type="button" class="btn">Создать ссылку</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, collection, getDocs, getDoc, doc,
    setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // === CONFIG ===
  const CFG = window.__FIREBASE_CONFIG__;
  const COL = (window.__FIREBASE_COLLECTIONS__ || { 
    venues:"venues", 
    shortlists:"shortlists", 
    singers:"singers", 
    singer_shortlists:"singer_shortlists",
    car_providers:"car_providers",
    car_shortlists:"car_shortlists"
  });

  // === CATALOG CONFIGURATION ===
  const CATALOG_CONFIG = {
    venues: {
      collection: 'venues',
      shortlistCollection: 'shortlists',
      title: 'Картотека площадок',
      filterLayout: '2fr 1fr 1fr 1fr',
      filters: {
        search: { id: 'fSearch', placeholder: 'Поиск: название, район, теги…', type: 'text' },
        district: { id: 'fDistrict', placeholder: 'Все районы', type: 'select' },
        capacity: { id: 'fCap', placeholder: 'Вместимость: 100-300', type: 'text' },
        price: { id: 'fPrice', placeholder: 'Цена/гость: 20-100', type: 'text' }
      }
    },
    singers: {
      collection: 'singers',
      shortlistCollection: 'singer_shortlists',
      title: 'Каталог певцов',
      filterLayout: '2fr 1fr 1fr 1fr 1fr 1fr',
      filters: {
        search: { id: 'fSearch', placeholder: 'Поиск: имя, псевдоним, теги…', type: 'text' },
        price: { id: 'fPrice', placeholder: 'Цена выступления: 500-2000', type: 'text' },
        gender: { id: 'fGender', placeholder: 'Все', type: 'select', options: ['Все', 'female', 'male', 'group', 'duo'] },
        genres: { id: 'fGenres', placeholder: 'Жанры', type: 'select' },
        languages: { id: 'fLanguages', placeholder: 'Языки', type: 'select' },
        city: { id: 'fCity', placeholder: 'Все города', type: 'select' }
      }
    },
    cars: {
      collection: 'car_providers',
      shortlistCollection: 'car_shortlists',
      title: 'Каталог автомобилей',
      filterLayout: '2fr 1fr 1fr 1fr 1fr',
      filters: {
        search: { id: 'fSearch', placeholder: 'Поиск: название, марка, модель…', type: 'text' },
        price: { id: 'fPrice', placeholder: 'Цена аренды: 50-200', type: 'text' },
        bodyType: { id: 'fBodyType', placeholder: 'Тип кузова', type: 'select' },
        brand: { id: 'fBrand', placeholder: 'Марка', type: 'select' },
        city: { id: 'fCity', placeholder: 'Все города', type: 'select' }
      }
    }
  };

  let activeCatalog = 'venues';  // текущий каталог

  // === refs для фильтров (объявляем заранее!)
  let $fSearch, $fDistrict, $fCap, $fPrice, $fGender, $fGenres, $fLanguages, $fCity, $fBodyType, $fBrand;

  // === GLOBALS ===
  let db, auth;
  let pickMode = false;
  const selected = new Set();
  let lastGeneratedUrl = "";
  let touchStartX = null;

  let filtersBound = false;           // для единовременной привязки слушателей

  // сохранённые для «мягкой» перерисовки
  window.__lastVenues = [];
  window.__lastMeta   = null;

  // утилиты
  const fmt = (n) => new Intl.NumberFormat('ru-RU').format(n);
  
  // Парсим число
  const toNum = (x) => {
    if (x == null) return NaN;
    if (typeof x === 'number') return x;
    if (typeof x === 'string') {
      const m = x.replace(',', '.').match(/-?\d+(\.\d+)?/);
      return m ? parseFloat(m[0]) : NaN;
    }
    return NaN;
  };
  
  // Диапазон цен из меню (price_azn)
  function getPriceRangeFromMenu(menu) {
    if (!menu || !Array.isArray(menu)) return { min: NaN, max: NaN };
    const prices = [];
    for (const cat of menu) {
      const items = Array.isArray(cat?.items) ? cat.items : [];
      for (const it of items) {
        const p = toNum(it?.price_azn ?? it?.priceAZN ?? it?.price);
        if (!Number.isNaN(p)) prices.push(p);
      }
    }
    if (!prices.length) return { min: NaN, max: NaN };
    return { min: Math.min(...prices), max: Math.max(...prices) };
  }
  
  // Единая точка получения диапазона цены площадки
  function getVenuePriceMinMax(v) {
    // сначала пробуем «прямые» поля (если когда-нибудь появятся)
    let pMin = toNum(v.price_min ?? v.priceMin ?? v.min_price ?? v.pricing_min ?? v.price?.min);
    let pMax = toNum(v.price_max ?? v.priceMax ?? v.max_price ?? v.pricing_max ?? v.price?.max);
    // если пусто — считаем из меню
    if (Number.isNaN(pMin) && Number.isNaN(pMax)) {
      const viaMenu = getPriceRangeFromMenu(v.menu);
      pMin = viaMenu.min; pMax = viaMenu.max;
    }
    return { min: pMin, max: pMax };
  }
  
  // Диапазон вместимости площадки
  function getVenueCapacityMinMax(v) {
    const cMin = toNum(v.capacity_min ?? v.capacityMin ?? v.min_capacity ?? v.capacity?.min);
    const cMax = toNum(v.capacity_max ?? v.capacityMax ?? v.max_capacity ?? v.capacity?.max);
    return { min: cMin, max: cMax };
  }
  
  // Совпадение диапазона вместимости по фильтру
  // Одинокое число = "нужно уместить N гостей": требуется cMin <= N <= cMax
  function capacityMatches(cMin, cMax, capLo, capHi) {
    if (Number.isNaN(cMin) || Number.isNaN(cMax)) return false;
    if (capLo == null && capHi == null) return true;
    if (capHi == null && capLo != null) {          // одиночное число
      return cMin <= capLo && cMax >= capLo;
    }
    // диапазон → пересечение
    if (capLo != null && cMax < capLo) return false;
    if (capHi != null && cMin > capHi) return false;
    return true;
  }
  
  // Совпадение диапазона цены по фильтру (аналогично вместимости)
  function priceMatches(pMin, pMax, priceLo, priceHi) {
    // Если фильтр не установлен - пропускаем всех (даже с NaN)
    if (priceLo == null && priceHi == null) return true;
    
    // Если у объекта нет цены (NaN) - не показываем только если фильтр установлен
    if (Number.isNaN(pMin) || Number.isNaN(pMax)) return false;
    
    if (priceHi == null && priceLo != null) {      // одиночное число
      return pMin <= priceLo && pMax >= priceLo;
    }
    // диапазон → пересечение
    if (priceLo != null && pMax < priceLo) return false;
    if (priceHi != null && pMin > priceHi) return false;
    return true;
  }
  
  const sha256Hex = async (text) => {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
  };

  // === SINGER-SPECIFIC HELPERS ===
  function getSingerPrice(singer) {
    // pricing_packages теперь загружается отдельно и добавляется в singer._pricing_packages
    const packages = singer._pricing_packages || [];
    if (!packages.length) {
      return { min: NaN, max: NaN };
    }
    const active = packages.filter(p => p.is_active !== false);
    const prices = active.map(p => toNum(p.price)).filter(p => !Number.isNaN(p));
    if (!prices.length) return { min: NaN, max: NaN };
    return { min: Math.min(...prices), max: Math.max(...prices) };
  }

  function getGenderLabel(gender) {
    const labels = { female: 'Женский', male: 'Мужской', group: 'Группа', duo: 'Дуэт' };
    return labels[gender] || gender;
  }

  function debounce(fn, ms=200){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
  }

  function normalizeMedia(m) {
    if (!m) return [];
    if (Array.isArray(m)) {
      return m.flatMap(x => {
        if (typeof x === 'string') return [{ type:'image', url:x }];
        if (x && typeof x === 'object') {
          const url = x.url || x.src || x.image || x.link;
          return url ? [{ type: x.type || 'image', url }] : [];
        }
        return [];
      });
    }
    if (typeof m === 'string') return [{ type:'image', url:m }];
    if (typeof m === 'object') {
      const out = [];
      const pushArr = (arr, typeGuess='image') => {
        if (!Array.isArray(arr)) return;
        arr.forEach(v => {
          if (typeof v === 'string') out.push({ type:typeGuess, url:v });
          else if (v && typeof v === 'object') {
            const url = v.url || v.src || v.image || v.link;
            if (url) out.push({ type: v.type || typeGuess, url });
          }
        });
      };
      pushArr(m.photos || m.images || m.pictures, 'image');
      pushArr(m.videos || m.video, 'video');
      if (!out.length) {
        const url = m.url || m.src || m.image || m.link;
        if (url) out.push({ type:m.type || 'image', url });
      }
      return out;
    }
    return [];
  }

  function getDistrictValue(){
    if (!$fDistrict) return '';
    const v = ($fDistrict.value || '').trim();
    const low = v.toLowerCase();
    // любые варианты «все районы» считаем пустым значением
    if (v === '' || low === 'все районы' || low === 'all' ) return '';
    return [];
  }

  // === MODAL HELPERS ===
  let currentRepertoire = [];
  let currentSinger = null;

  async function openRepertoireModal(singer) {
    if (!singer) return;
    currentSinger = singer;
    
    // Загружаем репертуар из связанных коллекций
    currentRepertoire = [];
    const repertoireIds = singer.assignedRepertoireIds || [];
    
    try {
      for (const repId of repertoireIds) {
        const repDoc = await getDoc(doc(db, 'repertoires', repId));
        if (repDoc.exists()) {
          const repData = repDoc.data();
          const songIds = repData.songIds || [];
          
          // Загружаем песни
          for (const songId of songIds) {
            const songDoc = await getDoc(doc(db, 'songs', songId));
            if (songDoc.exists()) {
              currentRepertoire.push({ id: songDoc.id, ...songDoc.data() });
            }
          }
        }
      }
    } catch (err) {
      console.error('Error loading repertoire:', err);
    }
    
    const $modal = document.getElementById('repertoireModal');
    const $body = document.getElementById('repertoireBody');
    const $search = document.getElementById('repSearch');
    const $langFilter = document.getElementById('repLangFilter');
    
    // Populate language filter
    const langs = Array.from(new Set(currentRepertoire.map(s => s.language).filter(Boolean))).sort();
    $langFilter.innerHTML = '<option value="">Все языки</option>' + 
      langs.map(l => `<option value="${l}">${l.toUpperCase()}</option>`).join('');
    
    $search.value = '';
    $langFilter.value = '';
    
    renderRepertoire();
    $modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeRepertoireModal() {
    const $modal = document.getElementById('repertoireModal');
    $modal.classList.remove('show');
    document.body.style.overflow = '';
    currentRepertoire = [];
    currentSinger = null;
  }

  function renderRepertoire() {
    const $body = document.getElementById('repertoireBody');
    const $search = document.getElementById('repSearch');
    const $langFilter = document.getElementById('repLangFilter');
    
    const q = ($search?.value || '').trim().toLowerCase();
    const lang = $langFilter?.value || '';
    
    let filtered = currentRepertoire.filter(song => {
      if (lang && song.language !== lang) return false;
      if (q && !(song.title || '').toLowerCase().includes(q) && !(song.original_artist || '').toLowerCase().includes(q)) return false;
      return true;
    });
    
    if (!filtered.length) {
      $body.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:20px">Ничего не найдено</p>';
      return;
    }
    
    // Group by language
    const byLang = {};
    filtered.forEach(s => {
      const l = s.language || 'other';
      if (!byLang[l]) byLang[l] = [];
      byLang[l].push(s);
    });
    
    let html = '';
    Object.keys(byLang).sort().forEach(lang => {
      html += `<div style="margin-bottom:16px">
        <div style="font-weight:600;font-size:15px;margin-bottom:8px;color:#475569">
          ${lang.toUpperCase()} (${byLang[lang].length})
        </div>
        <ul style="list-style:none;padding:0;margin:0">`;
      byLang[lang].forEach(s => {
        const dur = s.duration_sec ? ` • ${Math.floor(s.duration_sec/60)}:${String(s.duration_sec%60).padStart(2,'0')}` : '';
        html += `<li style="padding:6px 0;border-bottom:1px solid #f1f5f9">
          <div style="font-weight:500">${s.title || ''}</div>
          <div style="font-size:13px;color:#64748b">${s.original_artist || ''}${dur}</div>
        </li>`;
      });
      html += '</ul></div>';
    });
    
    $body.innerHTML = html;
  }

  function openPackagesModal(singer) {
    if (!singer) return;
    const $modal = document.getElementById('packagesModal');
    const $body = document.getElementById('packagesBody');
    
    const packages = singer._pricing_packages || [];
    const active = packages.filter(p => p.is_active !== false);
    if (!active.length) {
      $body.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:20px">Пакеты не указаны</p>';
    } else {
      let html = '<div style="display:grid;gap:16px">';
      active.forEach(pkg => {
        html += `<div style="border:1px solid var(--border);border-radius:12px;padding:16px">
          <div style="font-weight:600;font-size:16px;margin-bottom:4px">${pkg.title || ''}</div>
          <div style="font-size:20px;font-weight:700;color:#2563eb;margin-bottom:8px">
            ${fmt(pkg.price)} ${pkg.currency || 'AZN'}
          </div>
          ${pkg.duration_min ? `<div style="font-size:14px;color:#64748b;margin-bottom:8px">⏱ ${pkg.duration_min} минут</div>` : ''}
          ${pkg.description ? `<div style="font-size:14px;color:#475569">${pkg.description}</div>` : ''}
        </div>`;
      });
      html += '</div>';
      $body.innerHTML = html;
    }
    
    $modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closePackagesModal() {
    const $modal = document.getElementById('packagesModal');
    $modal.classList.remove('show');
    document.body.style.overflow = '';
  }

  function openContactsModal(singer) {
    if (!singer) return;
    const $modal = document.getElementById('contactsModal');
    const $body = document.getElementById('contactsBody');
    
    const socialData = {
      instagram: { label: 'Instagram', icon: 'https://cdn-icons-png.flaticon.com/512/174/174855.png', bg: 'linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%)' },
      facebook: { label: 'Facebook', icon: 'https://cdn-icons-png.flaticon.com/512/124/124010.png', bg: '#1877f2' },
      youtube: { label: 'YouTube', icon: 'https://cdn-icons-png.flaticon.com/512/1384/1384060.png', bg: '#ff0000' },
      tiktok: { label: 'TikTok', icon: 'https://cdn-icons-png.flaticon.com/512/3046/3046121.png', bg: '#000000' },
      twitter: { label: 'Twitter', icon: 'https://cdn-icons-png.flaticon.com/512/124/124021.png', bg: '#1da1f2' },
      vk: { label: 'ВКонтакте', icon: 'https://cdn-icons-png.flaticon.com/512/145/145813.png', bg: '#0077ff' },
      telegram: { label: 'Telegram', icon: 'https://cdn-icons-png.flaticon.com/512/2111/2111646.png', bg: '#0088cc' }
    };
    
    let html = `
      <button onclick="closeContactsModal()" style="
        position:absolute;
        top:16px;
        right:16px;
        width:32px;
        height:32px;
        border:none;
        background:#f1f5f9;
        border-radius:50%;
        cursor:pointer;
        font-size:18px;
        color:#64748b;
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:10;
        transition:all 0.2s;
      " onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">✕</button>
      <div style="padding:24px 24px 28px;">
        <h3 style="margin:0 0 20px;font-size:18px;color:#0f172a;font-weight:600">Соцсети</h3>
        <div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center">
    `;
    
    if (singer.contact_public && typeof singer.contact_public === 'object') {
      const entries = Object.entries(singer.contact_public).filter(([k, v]) => v);
      
      if (entries.length === 0) {
        html += '<p style="color:#6b7280;text-align:center;padding:24px;margin:0;width:100%">Соцсети не указаны</p>';
      } else {
        entries.forEach(([key, val]) => {
          const data = socialData[key.toLowerCase()] || { 
            label: key.charAt(0).toUpperCase() + key.slice(1), 
            icon: 'https://cdn-icons-png.flaticon.com/512/1384/1384005.png',
            bg: '#64748b'
          };
          
          html += `
            <a href="${val}" target="_blank" rel="noopener noreferrer" 
               style="
                 display:flex;
                 flex-direction:column;
                 align-items:center;
                 gap:10px;
                 padding:16px;
                 background:#ffffff;
                 border:1px solid #e5e7eb;
                 border-radius:16px;
                 text-decoration:none;
                 color:#0f172a;
                 font-weight:500;
                 font-size:13px;
                 text-align:center;
                 transition:all 0.2s;
                 box-shadow:0 1px 3px rgba(0,0,0,0.08);
                 min-width:110px;
               "
               onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.12)'"
               onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'"
            >
              <div style="
                width:56px;
                height:56px;
                border-radius:14px;
                background:${data.bg};
                display:flex;
                align-items:center;
                justify-content:center;
                padding:12px;
              ">
                <img src="${data.icon}" alt="${data.label}" style="width:100%;height:100%;object-fit:contain;filter:brightness(0) invert(1)">
              </div>
              <span style="color:#334155">${data.label}</span>
            </a>
          `;
        });
      }
    } else {
      html += '<p style="color:#6b7280;text-align:center;padding:24px;margin:0;width:100%">Соцсети не указаны</p>';
    }
    
    html += '</div></div>';
    $body.innerHTML = html;
    
    $modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeContactsModal() {
    const $modal = document.getElementById('contactsModal');
    $modal.classList.remove('show');
    document.body.style.overflow = '';
  }

  // === CAR DETAILS MODAL ===
  function openCarDetailsModal(car) {
    if (!car) return;
    const $modal = document.getElementById('carDetailsModal');
    const $body = document.getElementById('carDetailsBody');
    
    let html = '<div style="display:grid;gap:16px">';
    
    if (Array.isArray(car.cars) && car.cars.length > 0) {
      car.cars.forEach((c, idx) => {
        const brand = c.brand || '';
        const model = c.model || '';
        const bodyType = c.body_type || '';
        const carClass = c.class || '';
        const year = c.year || '';
        const doors = c.doors || '';
        const seats = c.seats || '';
        const color = c.color || '';
        
        // Фото автомобиля
        const photo = Array.isArray(c.media?.photos) && c.media.photos.length ? c.media.photos[0] : null;
        
        // Особенности
        const features = [];
        if (Array.isArray(c.car_features)) {
          features.push(...c.car_features);
        }
        
        // Опции передачи
        const handover = c.handover || {};
        const handoverMode = handover.mode || '';
        const selfDrive = handover.self_drive?.enabled ? 'Да' : 'Нет';
        const withDriver = handover.with_driver?.driver_languages?.length 
          ? `Да (${handover.with_driver.driver_languages.join(', ')})` 
          : 'Нет';
        
        html += `
          <div style="border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff">
            ${photo ? `<img src="${photo}" alt="${brand} ${model}" style="width:100%;height:200px;object-fit:cover;border-radius:8px;margin-bottom:12px">` : ''}
            
            <div style="font-weight:600;font-size:16px;margin-bottom:8px">${brand} ${model}</div>
            
            <div style="display:grid;gap:6px;font-size:14px;color:#64748b">
              ${bodyType ? `<div><strong>Тип кузова:</strong> ${bodyType}</div>` : ''}
              ${carClass ? `<div><strong>Класс:</strong> ${carClass}</div>` : ''}
              ${year ? `<div><strong>Год:</strong> ${year}</div>` : ''}
              ${color ? `<div><strong>Цвет:</strong> ${color}</div>` : ''}
              ${doors ? `<div><strong>Дверей:</strong> ${doors}</div>` : ''}
              ${seats ? `<div><strong>Мест:</strong> ${seats}</div>` : ''}
            </div>
            
            ${features.length ? `
              <div style="margin-top:10px">
                <div style="font-weight:600;font-size:14px;margin-bottom:6px">Особенности:</div>
                <div style="display:flex;gap:6px;flex-wrap:wrap">
                  ${features.map(f => `<span style="background:#f1f5f9;padding:4px 10px;border-radius:6px;font-size:13px">${f}</span>`).join('')}
                </div>
              </div>
            ` : ''}
            
            ${handoverMode ? `
              <div style="margin-top:10px">
                <div style="font-weight:600;font-size:14px;margin-bottom:6px">Варианты передачи:</div>
                <div style="font-size:14px;color:#64748b">
                  <div><strong>Режим:</strong> ${handoverMode}</div>
                  <div><strong>Самостоятельное вождение:</strong> ${selfDrive}</div>
                  <div><strong>С водителем:</strong> ${withDriver}</div>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      });
    } else {
      html += '<p style="color:#6b7280;text-align:center;padding:20px">Нет данных об автомобилях</p>';
    }
    
    html += '</div>';
    $body.innerHTML = html;
    
    $modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeCarDetailsModal() {
    const $modal = document.getElementById('carDetailsModal');
    $modal.classList.remove('show');
    document.body.style.overflow = '';
  }

  // Bind modal events
  window.closeRepertoireModal = closeRepertoireModal;
  window.closePackagesModal = closePackagesModal;
  window.closeContactsModal = closeContactsModal;
  window.closeCarDetailsModal = closeCarDetailsModal;

  // ждём DOM — тут мы берём все элементы и вешаем обработчики
  window.addEventListener('DOMContentLoaded', async () => {
    // Firebase
    const app = initializeApp(CFG);
    db   = getFirestore(app);
    auth = getAuth(app);
    signInAnonymously(auth).catch(console.error);

    // DOM refs
    const $status    = document.getElementById('status') || {textContent:''};
    const $grid      = document.getElementById('grid');
    const $empty     = document.getElementById('empty');
    const $modeToggle= document.getElementById('modeToggle');
    const $genBtn    = document.getElementById('genBtn');
    const $selCount  = document.getElementById('selCount');
    const $shareBox  = document.getElementById('shareBox');
    const $copyBtn   = document.getElementById('copyBtn');
    const $waBtn     = document.getElementById('waBtn');
    const $tgBtn     = document.getElementById('tgBtn');
    const $toast     = document.getElementById('toast');
    const $pageTitle = document.getElementById('pageTitle');
    const $filtersContainer = document.getElementById('filters');

    // каталог табы
    const $catalogTabs = document.getElementById('catalogTabs');
    
    // фильтры (будут переинициализироваться при смене каталога)
    $fSearch   = document.getElementById('fSearch');
    $fDistrict = document.getElementById('fDistrict');
    $fCap      = document.getElementById('fCap');
    $fPrice    = document.getElementById('fPrice');
    $fGender   = document.getElementById('fGender');
    $fGenres   = document.getElementById('fGenres');
    $fLanguages= document.getElementById('fLanguages');
    $fCity     = document.getElementById('fCity');

    // Галерея (элементы уже есть внизу body)
    const $g      = document.getElementById('gallery');
    const $gImg   = document.getElementById('gallery-img');
    const $gStrip = document.getElementById('gallery-strip');
    const $gPrev  = document.getElementById('gallery-prev');
    const $gNext  = document.getElementById('gallery-next');
    const $gClose = document.getElementById('gallery-close');
    let galleryUrls = [];
    let galleryIndex = 0;

    // данные для фильтрации
    let _allVenues = [];   // полный список (или подмножество шортлиста)
    let _viewVenues = [];  // после фильтрации

    // ---- link-config modal
    const $cfg     = document.getElementById('linkConfig');
    const $cfgClose= document.getElementById('cfgClose');
    const $cfgCancel= document.getElementById('cfgCancel');
    const $cfgCreate= document.getElementById('cfgCreate');
    const $cfgExpire= document.getElementById('cfgExpire');
    const $cfgDateWrap= document.getElementById('cfgDateWrap');
    const $cfgDate = document.getElementById('cfgDate');
    const $cfgSlug = document.getElementById('cfgSlug');
    const $cfgNote = document.getElementById('cfgNote');

    function openCfg() { $cfg.style.display='flex'; }
    function closeCfg(){ $cfg.style.display='none'; }
    $cfgClose?.addEventListener('click', closeCfg);
    $cfgCancel?.addEventListener('click', closeCfg);
    $cfg?.addEventListener('click', (e)=>{ if(e.target===$cfg) closeCfg(); });
    $cfgExpire?.addEventListener('change', ()=>{
      $cfgDateWrap.style.display = ($cfgExpire.value === 'custom') ? 'grid' : 'none';
    });

    // ---- Gallery helpers
    function renderGallery(){
      $gImg.src = galleryUrls[galleryIndex];
      $gStrip.innerHTML = '';
      galleryUrls.forEach((u,i)=>{
        const img = document.createElement('img');
        img.className = 'gallery-thumb' + (i===galleryIndex ? ' active' : '');
        img.src = u;
        img.addEventListener('click', ()=>{ galleryIndex=i; renderGallery(); });
        $gStrip.appendChild(img);
      });
    }
    function openGallery(urls, startIdx=0){
      galleryUrls = urls.filter(Boolean);
      if (!galleryUrls.length) return;
      galleryIndex = Math.min(Math.max(0, startIdx), galleryUrls.length-1);
      renderGallery();
      $g.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeGallery(){
      $g.classList.remove('show');
      document.body.style.overflow = '';
    }
    $gNext?.addEventListener('click', ()=>{ galleryIndex=(galleryIndex+1)%galleryUrls.length; renderGallery(); });
    $gPrev?.addEventListener('click', ()=>{ galleryIndex=(galleryIndex-1+galleryUrls.length)%galleryUrls.length; renderGallery(); });
    $gClose?.addEventListener('click', closeGallery);
    $g?.addEventListener('click', (e)=>{ if(e.target===$g) closeGallery(); });
    window.addEventListener('keydown', (e)=>{
      if(!$g.classList.contains('show')) return;
      if(e.key==='Escape') closeGallery();
      if(e.key==='ArrowRight') $gNext.click();
      if(e.key==='ArrowLeft')  $gPrev.click();
    });
    $g?.addEventListener('touchstart', (e)=>{ touchStartX = e.changedTouches[0].clientX; }, {passive:true});
    $g?.addEventListener('touchend', (e)=>{
      if(touchStartX==null) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      if(Math.abs(dx) > 40) { dx<0 ? $gNext.click() : $gPrev.click(); }
      touchStartX = null;
    }, {passive:true});

    // ---- репертуар фильтры
    document.getElementById('repSearch')?.addEventListener('input', debounce(renderRepertoire, 200));
    document.getElementById('repLangFilter')?.addEventListener('change', renderRepertoire);

    // ---- Catalog Tabs
    function switchCatalog(catalog) {
      if (!CATALOG_CONFIG[catalog]) return;
      activeCatalog = catalog;
      
      // Update tab styles
      document.querySelectorAll('.catalog-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.catalog === catalog);
      });
      
      // Update title
      $pageTitle.textContent = CATALOG_CONFIG[catalog].title;
      
      // Reset selection mode
      pickMode = false;
      $modeToggle.checked = false;
      selected.clear();
      $selCount.textContent = 'Выбрано: 0';
      $genBtn.disabled = true;
      $shareBox.style.display = 'none';
      lastGeneratedUrl = '';
      
      // КРИТИЧНО: Rebuild filters ПЕРЕД загрузкой данных
      buildFilters(catalog);
      
      // Update URL
      const params = new URLSearchParams(location.search);
      params.set('catalog', catalog);
      history.replaceState(null, '', `${location.pathname}?${params.toString()}`);
      
      // Reload data (фильтры уже созданы)
      loadCatalogData(catalog);
    }
    
    $catalogTabs?.querySelectorAll('.catalog-tab').forEach(tab => {
      tab.addEventListener('click', () => switchCatalog(tab.dataset.catalog));
    });

    // ---- тост + копирование
    function showToast(text='Скопировано') {
      if (!$toast) return;
      $toast.textContent = text;
      $toast.style.opacity = '1';
      setTimeout(()=> $toast.style.opacity = '0', 1400);
    }
    async function copyToClipboard(text) {
      try { await navigator.clipboard.writeText(text); return true; } catch{}
      try {
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.select();
        const ok = document.execCommand('copy'); document.body.removeChild(ta);
        return ok;
      } catch { return false; }
    }
    document.getElementById('copyBtn')?.addEventListener('click', async () => {
      if (!lastGeneratedUrl) { alert('Сначала сгенерируйте ссылку.'); return; }
      const ok = await copyToClipboard(lastGeneratedUrl);
      showToast(ok ? 'Скопировано' : 'Скопируйте вручную');
    });

    // ---- режим подбора
    function rerender(){ render(window.__lastVenues, window.__lastMeta); }
    $modeToggle?.addEventListener('change', ()=>{
      pickMode = $modeToggle.checked;
      selected.clear();
      $selCount.textContent = 'Выбрано: 0';
      $genBtn.disabled = true;
      $shareBox.style.display = 'none';
      lastGeneratedUrl = '';
      rerender();
    });

    // ---- фильтры
    function buildFilters(catalog) {
      const config = CATALOG_CONFIG[catalog];
      if (!config || !$filtersContainer) return;
      
      // Update grid layout
      $filtersContainer.style.gridTemplateColumns = config.filterLayout;
      
      // Build filter inputs
      let html = '';
      Object.values(config.filters).forEach(f => {
        if (f.type === 'text') {
          html += `<input id="${f.id}" type="text" placeholder="${f.placeholder}" class="inp">`;
        } else if (f.type === 'select') {
          html += `<select id="${f.id}" class="inp">`;
          if (f.options) {
            html += f.options.map(opt => `<option value="${opt === 'Все' ? '' : opt}">${opt}</option>`).join('');
          } else {
            html += `<option value="">${f.placeholder}</option>`;
          }
          html += `</select>`;
        }
      });
      
      $filtersContainer.innerHTML = html;
      
      // КРИТИЧНО: Re-bind refs СРАЗУ после создания элементов
      $fSearch   = document.getElementById('fSearch');
      $fDistrict = document.getElementById('fDistrict');
      $fCap      = document.getElementById('fCap');
      $fPrice    = document.getElementById('fPrice');
      $fGender   = document.getElementById('fGender');
      $fGenres   = document.getElementById('fGenres');
      $fLanguages= document.getElementById('fLanguages');
      $fCity     = document.getElementById('fCity');
      $fBodyType = document.getElementById('fBodyType');
      $fBrand    = document.getElementById('fBrand');
      
      // Reset filtersBound flag to allow re-binding
      filtersBound = false;
    }
    
    function parseRange(text){
      if(!text) return [null,null];
      const m = (text.replace(/\s/g,'').match(/^(\d+)?-?(\d+)?$/) || []);
      return [m[1]?+m[1]:null, m[2]?+m[2]:null];
    }
    function populateDistricts(list){
      if(!$fDistrict) return;
      const districts = Array.from(new Set(list.map(v=>v.district).filter(Boolean))).sort();
      $fDistrict.innerHTML =
        '<option value="">Все районы</option>' +
        districts.map(d=>`<option value="${d}">${d}</option>`).join('');
    }
    
    function populateCities(list) {
      if (!$fCity) return;
      const cities = Array.from(new Set(list.map(s => s.city).filter(Boolean))).sort();
      $fCity.innerHTML =
        '<option value="">Все города</option>' +
        cities.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    function populateGenres(list) {
      if (!$fGenres) return;
      const genres = Array.from(new Set(list.flatMap(s => s.genres || []))).sort();
      $fGenres.innerHTML =
        '<option value="">Все жанры</option>' +
        genres.map(g => `<option value="${g}">${g}</option>`).join('');
    }
    
    function populateLanguages(list) {
      if (!$fLanguages) return;
      const langs = Array.from(new Set(list.flatMap(s => s.languages || []))).sort();
      $fLanguages.innerHTML =
        '<option value="">Все языки</option>' +
        langs.map(l => `<option value="${l}">${l.toUpperCase()}</option>`).join('');
    }
    
    function populateBodyTypes(list) {
      if (!$fBodyType) return;
      const bodyTypes = Array.from(new Set(
        list.flatMap(car => (car.cars || []).map(c => c.body_type).filter(Boolean))
      )).sort();
      $fBodyType.innerHTML =
        '<option value="">Все типы кузова</option>' +
        bodyTypes.map(bt => `<option value="${bt}">${bt}</option>`).join('');
    }
    
    function populateBrands(list) {
      if (!$fBrand) return;
      const brands = Array.from(new Set(
        list.flatMap(car => (car.cars || []).map(c => c.brand).filter(Boolean))
      )).sort();
      $fBrand.innerHTML =
        '<option value="">Все марки</option>' +
        brands.map(b => `<option value="${b}">${b}</option>`).join('');
    }
    
    function populateCarCities(list) {
      if (!$fCity) return;
      const cities = Array.from(new Set(
        list.flatMap(car => car.coverage_cities || [])
      )).sort();
      $fCity.innerHTML =
        '<option value="">Все города</option>' +
        cities.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    function ensureDistrictValid(){
      if (!$fDistrict) return;
      const val = ($fDistrict.value||'').trim();
      const opts = Array.from($fDistrict.options).map(o=>o.value);
      // если текущего value нет среди опций или это «Все районы» — сбрасываем
      if (!opts.includes(val) || val.toLowerCase()==='все районы' || val.toLowerCase()==='all') {
        $fDistrict.value = '';       // выберется первая опция <option value="">
        $fDistrict.selectedIndex = 0;
      }
    }    
    function restoreFiltersFromURL(){
      const ps = new URLSearchParams(location.search);
      if ($fSearch) $fSearch.value = ps.get('q') || '';
      
      // Для venues
      if ($fDistrict) $fDistrict.value = ps.get('d') || '';
      if ($fCap) $fCap.value = ps.get('cap') || '';
      
      // Для singers
      if ($fGender) $fGender.value = ps.get('gender') || '';
      if ($fGenres) $fGenres.value = ps.get('genre') || '';
      if ($fLanguages) $fLanguages.value = ps.get('lang') || '';
      
      // Для cars
      if ($fBodyType) $fBodyType.value = ps.get('bodyType') || '';
      if ($fBrand) $fBrand.value = ps.get('brand') || '';
      
      // Общие
      if ($fCity) $fCity.value = ps.get('city') || '';
      if ($fPrice) $fPrice.value = ps.get('price') || '';
    }
    function bindFilterEventsOnce(){
      if(filtersBound || !$fSearch) return;
      filtersBound = true;
      $fSearch.addEventListener('input', debounce(applyFilters,200));
      const allFilters = [$fDistrict,$fCap,$fPrice,$fGender,$fGenres,$fLanguages,$fCity,$fBodyType,$fBrand].filter(Boolean);
      allFilters.forEach(el=> el.addEventListener('input', applyFilters));
    }
    function applyFilters(){
      if(!$fSearch) return;
    
      const q = ($fSearch.value||'').trim().toLowerCase();
      
      if (activeCatalog === 'venues') {
        const dist = ($fDistrict?.value || '').trim();
        const [capLo, capHi]     = parseRange(($fCap?.value||'').trim());
        const [priceLo, priceHi] = parseRange(($fPrice?.value||'').trim());
      
        _viewVenues = _allVenues.filter(v=>{
          // поиск
          if(q){
            const hay = [v.name,v.city,v.district,(v.tags||[]).join(' '),v.description]
                        .filter(Boolean).join(' ').toLowerCase();
            if(!hay.includes(q)) return false;
          }
      
          // район
          if(dist && v.district !== dist) return false;
      
          // вместимость
          const {min: cMin, max: cMax} = getVenueCapacityMinMax(v);
          if(!capacityMatches(cMin, cMax, capLo, capHi)) return false;
      
          // цена/гость
          const {min: pMin, max: pMax} = getVenuePriceMinMax(v);
          if(!priceMatches(pMin, pMax, priceLo, priceHi)) return false;
      
          return true;
        });
        
        // синхронизация в URL
        const params = new URLSearchParams(location.search);
        q ? params.set('q', q) : params.delete('q');
        dist ? params.set('d', dist) : params.delete('d');
        $fCap?.value   ? params.set('cap', ($fCap.value||'').trim())     : params.delete('cap');
        $fPrice?.value ? params.set('price', ($fPrice.value||'').trim()) : params.delete('price');
        const newUrl = `${location.pathname}?${params.toString()}`;
        history.replaceState(null,'',newUrl);
        
      } else if (activeCatalog === 'singers') {
        const [priceLo, priceHi] = parseRange(($fPrice?.value||'').trim());
        const gender = ($fGender?.value || '').trim();
        const genre = ($fGenres?.value || '').trim();
        const lang = ($fLanguages?.value || '').trim();
        const city = ($fCity?.value || '').trim();
        
        console.log(`🔍 Applying filters: q="${q}", gender="${gender}", genre="${genre}", lang="${lang}", city="${city}", price="${priceLo}-${priceHi}"`);
        
        _viewVenues = _allVenues.filter(s => {
          // поиск
          if (q) {
            const hay = [s.name, (s.aliases||[]).join(' '), (s.tags||[]).join(' '), (s.genres||[]).join(' ')]
              .filter(Boolean).join(' ').toLowerCase();
            if (!hay.includes(q)) {
              console.log(`❌ ${s.id} (${s.name}): filtered by search "${q}"`);
              return false;
            }
          }
          
          // пол
          if (gender && s.gender !== gender) {
            console.log(`❌ ${s.id} (${s.name}): filtered by gender (has: ${s.gender}, need: ${gender})`);
            return false;
          }
          
          // жанр
          if (genre && (!Array.isArray(s.genres) || !s.genres.includes(genre))) {
            console.log(`❌ ${s.id} (${s.name}): filtered by genre (has: ${s.genres}, need: ${genre})`);
            return false;
          }
          
          // язык
          if (lang && (!Array.isArray(s.languages) || !s.languages.includes(lang))) {
            console.log(`❌ ${s.id} (${s.name}): filtered by language (has: ${s.languages}, need: ${lang})`);
            return false;
          }
          
          // город
          if (city && s.city !== city) {
            console.log(`❌ ${s.id} (${s.name}): filtered by city (has: ${s.city}, need: ${city})`);
            return false;
          }
          
          // цена
          const {min: pMin, max: pMax} = getSingerPrice(s);
          if (!priceMatches(pMin, pMax, priceLo, priceHi)) {
            console.log(`❌ ${s.id} (${s.name}): filtered by price (has: ${pMin}-${pMax}, need: ${priceLo}-${priceHi})`);
            return false;
          }
          
          return true;
        });
        
        // синхронизация в URL
        const params = new URLSearchParams(location.search);
        q ? params.set('q', q) : params.delete('q');
        $fPrice?.value ? params.set('price', ($fPrice.value||'').trim()) : params.delete('price');
        gender ? params.set('gender', gender) : params.delete('gender');
        genre ? params.set('genre', genre) : params.delete('genre');
        lang ? params.set('lang', lang) : params.delete('lang');
        city ? params.set('city', city) : params.delete('city');
        const newUrl = `${location.pathname}?${params.toString()}`;
        history.replaceState(null,'',newUrl);
        
      } else if (activeCatalog === 'cars') {
        const [priceLo, priceHi] = parseRange(($fPrice?.value||'').trim());
        const bodyType = ($fBodyType?.value || '').trim();
        const brand = ($fBrand?.value || '').trim();
        const city = ($fCity?.value || '').trim();
        
        console.log(`🔍 Applying filters for cars: q="${q}", bodyType="${bodyType}", brand="${brand}", city="${city}", price="${priceLo}-${priceHi}"`);
        
        _viewVenues = _allVenues.filter(car => {
          // поиск
          if (q) {
            const carModels = Array.isArray(car.cars) ? car.cars.map(c => [c.brand, c.model].filter(Boolean).join(' ')).join(' ') : '';
            const hay = [car.name, carModels, (car.tags||[]).join(' ')]
              .filter(Boolean).join(' ').toLowerCase();
            if (!hay.includes(q)) {
              console.log(`❌ ${car.id} (${car.name}): filtered by search "${q}"`);
              return false;
            }
          }
          
          // тип кузова
          if (bodyType && Array.isArray(car.cars)) {
            const hasBodyType = car.cars.some(c => c.body_type === bodyType);
            if (!hasBodyType) {
              console.log(`❌ ${car.id} (${car.name}): filtered by bodyType (need: ${bodyType})`);
              return false;
            }
          }
          
          // марка
          if (brand && Array.isArray(car.cars)) {
            const hasBrand = car.cars.some(c => c.brand === brand);
            if (!hasBrand) {
              console.log(`❌ ${car.id} (${car.name}): filtered by brand (need: ${brand})`);
              return false;
            }
          }
          
          // город
          if (city && (!Array.isArray(car.coverage_cities) || !car.coverage_cities.includes(city))) {
            console.log(`❌ ${car.id} (${car.name}): filtered by city (has: ${car.coverage_cities}, need: ${city})`);
            return false;
          }
          
          // цена
          const basePrice = car.pricing?.price?.base;
          const pMin = basePrice && !isNaN(basePrice) ? basePrice : NaN;
          const pMax = pMin;
          if (!priceMatches(pMin, pMax, priceLo, priceHi)) {
            console.log(`❌ ${car.id} (${car.name}): filtered by price (has: ${pMin}, need: ${priceLo}-${priceHi})`);
            return false;
          }
          
          return true;
        });
        
        // синхронизация в URL
        const params = new URLSearchParams(location.search);
        q ? params.set('q', q) : params.delete('q');
        $fPrice?.value ? params.set('price', ($fPrice.value||'').trim()) : params.delete('price');
        bodyType ? params.set('bodyType', bodyType) : params.delete('bodyType');
        brand ? params.set('brand', brand) : params.delete('brand');
        city ? params.set('city', city) : params.delete('city');
        const newUrl = `${location.pathname}?${params.toString()}`;
        history.replaceState(null,'',newUrl);
      }
    
      render(_viewVenues, window.__lastMeta);
    }


    // ---- RENDER CARDS HELPERS ===
    function renderVenueCard(v) {
      // обложка
      let coverUrl = Array.isArray(v.media?.photos) && v.media.photos.length ? v.media.photos[0] : null;
      const mediaArr = normalizeMedia(v.media);
      if (!coverUrl && mediaArr.length) coverUrl = mediaArr[0]?.url || null;

      // SVG иконки (16x16)
      const svgPin = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 22s7-5.33 7-12a7 7 0 10-14 0c0 6.67 7 12 7 12z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.7" fill="none"/>
      </svg>`;
      const svgMoney = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <path d="M7 12h10M12 9v6" stroke="currentColor" stroke-width="1.7" />
      </svg>`;
      const svgUsers = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <circle cx="9" cy="8" r="3" stroke="currentColor" stroke-width="1.7"/>
        <path d="M2 19a7 7 0 0114 0" stroke="currentColor" stroke-width="1.7"/>
        <path d="M17 11a2 2 0 100-4" stroke="currentColor" stroke-width="1.7"/>
        <path d="M20.5 19a5.5 5.5 0 00-5.5-4" stroke="currentColor" stroke-width="1.7"/>
      </svg>`;
      
      const rawPriceMin = v.price_min ?? v.priceMin ?? v.min_price ?? v.pricing_min ?? (v.price && v.price.min);
      const rawPriceMax = v.price_max ?? v.priceMax ?? v.max_price ?? v.pricing_max ?? (v.price && v.price.max);
      
      let pMinNum = toNum(rawPriceMin);
      let pMaxNum = toNum(rawPriceMax);
      
      if (Number.isNaN(pMinNum) && Number.isNaN(pMaxNum)) {
        const fromMenu = getPriceRangeFromMenu(v.menu);
        pMinNum = fromMenu.min;
        pMaxNum = fromMenu.max;
      }
      
      const hasPMin = !Number.isNaN(pMinNum);
      const hasPMax = !Number.isNaN(pMaxNum);
      const hasPriceAny = hasPMin || hasPMax;
      
      const currency = v.currency || 'AZN';
      const priceText = hasPriceAny
      ? (hasPMin && hasPMax ? `${fmt(pMinNum)}–${fmt(pMaxNum)} ${currency}`
         : hasPMin ? `от ${fmt(pMinNum)} ${currency}`
         : `до ${fmt(pMaxNum)} ${currency}`)
      : '';
      
      const cMinNum = Number(v.capacity_min), cMaxNum = Number(v.capacity_max);
      const hasCMin = !Number.isNaN(cMinNum), hasCMax = !Number.isNaN(cMaxNum);
      const hasCapAny = hasCMin || hasCMax;
      const capText = hasCapAny
        ? (hasCMin && hasCMax ? `${fmt(cMinNum)}–${fmt(cMaxNum)}`
           : hasCMin ? `от ${fmt(cMinNum)}`
           : `до ${fmt(cMaxNum)}`)
        : '';
      
      const mapHref = v.location_url || ((v.location_lat!=null && v.location_lng!=null)
        ? `https://maps.google.com/?q=${v.location_lat},${v.location_lng}` : '');
      
      return `
        ${coverUrl ? `<img class="img venue-cover" src="${coverUrl}" alt="${v.name||''}" loading="lazy">` : `<div class="img venue-cover"></div>`}
        <div class="body">
          <div class="row">
            <div>
              <div style="font-weight:600;font-size:18px">${v.name||''}</div>
              <div class="loc" style="display:flex;align-items:center;gap:6px;color:#64748b;">
                <span class="ico" style="display:inline-flex;line-height:0;">${svgPin}</span>
                <span>${[v.city, v.district].filter(Boolean).join(', ')}</span>
              </div>
            </div>
            <div style="text-align:right;font-size:14px;color:#475569">
              ${hasPriceAny ? `<div style="display:flex;gap:6px;justify-content:flex-end;align-items:center;">
                  <span class="ico" style="display:inline-flex;line-height:0;">${svgMoney}</span>
                  <span>${priceText}</span>
                </div>` : ''}
              ${hasCapAny ? `<div style="display:flex;gap:6px;justify-content:flex-end;align-items:center;margin-top:2px;">
                  <span class="ico" style="display:inline-flex;line-height:0;">${svgUsers}</span>
                  <span>${capText}</span>
                </div>` : ''}
            </div>
          </div>
      
          <div class="btns">
            ${mediaArr.length ? `<button class="btn venue-media">Медиа</button>` : ''}
            ${mapHref ? `<button class="btn venue-map" data-href="${mapHref}">Карта</button>` : ''}
          </div>
        </div>
      `;
    }

    function renderSingerCard(s) {
      const coverUrl = (Array.isArray(s.media?.photos) && s.media.photos.length) ? s.media.photos[0] : null;
      
      const svgPin = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 22s7-5.33 7-12a7 7 0 10-14 0c0 6.67 7 12 7 12z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.7" fill="none"/>
      </svg>`;
      const svgMoney = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <path d="M7 12h10M12 9v6" stroke="currentColor" stroke-width="1.7" />
      </svg>`;
      const svgMic = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <rect x="9" y="2" width="6" height="11" rx="3" stroke="currentColor" stroke-width="1.7"/>
        <path d="M5 10v2a7 7 0 0014 0v-2M12 19v3M8 22h8" stroke="currentColor" stroke-width="1.7"/>
      </svg>`;
      const svgGlobe = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.7"/>
        <path d="M2 12h20M12 2a15 15 0 010 20M12 2a15 15 0 000 20" stroke="currentColor" stroke-width="1.7"/>
      </svg>`;
      
      const {min: pMin, max: pMax} = getSingerPrice(s);
      const hasPMin = !Number.isNaN(pMin);
      const hasPMax = !Number.isNaN(pMax);
      const hasPriceAny = hasPMin || hasPMax;
      const packages = s._pricing_packages || [];
      const currency = packages[0]?.currency || 'AZN';
      const priceText = hasPriceAny
        ? (hasPMin && hasPMax ? `${fmt(pMin)}–${fmt(pMax)} ${currency}`
           : hasPMin ? `от ${fmt(pMin)} ${currency}`
           : `до ${fmt(pMax)} ${currency}`)
        : '';
      
      const genderLabel = getGenderLabel(s.gender);
      const genresText = Array.isArray(s.genres) && s.genres.length ? s.genres.slice(0, 3).join(', ') : '';
      const langsText = Array.isArray(s.languages) && s.languages.length ? s.languages.map(l => l.toUpperCase()).join(', ') : '';
      const regionsText = Array.isArray(s.regions_covered) && s.regions_covered.length ? s.regions_covered.slice(0, 3).join(', ') : '';
      const repCount = Array.isArray(s.assignedRepertoireIds) ? s.assignedRepertoireIds.length : 0;
      
      return `
        ${coverUrl ? `<img class="img singer-cover" src="${coverUrl}" alt="${s.name||''}" loading="lazy">` : `<div class="img singer-cover"></div>`}
        <div class="body">
          <div style="margin-bottom:8px">
            <div style="font-weight:600;font-size:18px">${s.name||''}</div>
            ${s.aliases?.length ? `<div style="font-size:13px;color:#9ca3af">${s.aliases.join(', ')}</div>` : ''}
          </div>
          
          <div style="font-size:14px;color:#64748b;display:grid;gap:4px;margin-bottom:10px">
            ${s.city ? `<div style="display:flex;align-items:center;gap:6px;">
              <span style="display:inline-flex;line-height:0;">${svgPin}</span>
              <span>${s.city}${regionsText ? ' • ' + regionsText : ''}</span>
            </div>` : ''}
            ${genresText ? `<div style="display:flex;align-items:center;gap:6px;">
              <span style="display:inline-flex;line-height:0;">${svgMic}</span>
              <span>${genresText}</span>
            </div>` : ''}
            ${langsText ? `<div style="display:flex;align-items:center;gap:6px;">
              <span style="display:inline-flex;line-height:0;">${svgGlobe}</span>
              <span>${langsText}</span>
            </div>` : ''}
          </div>
          
          ${hasPriceAny ? `<div style="display:flex;align-items:center;gap:6px;font-size:18px;font-weight:700;color:#2563eb;margin-bottom:10px">
            <span style="display:inline-flex;line-height:0;">${svgMoney}</span>
            <span>${priceText}</span>
          </div>` : ''}
          
          <div class="btns">
            ${repCount > 0 ? `<button class="btn singer-repertoire">Репертуар</button>` : ''}
            ${(s._pricing_packages?.length) ? `<button class="btn singer-packages">Пакеты</button>` : ''}
            ${(s.phones?.length || s.contact_public) ? `<button class="btn singer-contacts">Соцсети</button>` : ''}
          </div>
        </div>
      `;
    }

    function bindVenueCardActions(card, v) {
      const mediaArr = normalizeMedia(v.media);
      const allPhotoUrls = Array.isArray(v.media?.photos) ? v.media.photos.filter(Boolean) : [];
      const fallbackUrls = mediaArr.map(m => m?.url).filter(Boolean);
      const allMediaUrls = Array.from(new Set([...allPhotoUrls, ...fallbackUrls]));
      
      const mediaBtn = card.querySelector('.venue-media');
      mediaBtn?.addEventListener('click', () => openGallery(allMediaUrls, 0));
      
      const mapBtn = card.querySelector('.venue-map');
      mapBtn?.addEventListener('click', () => {
        const href = mapBtn.dataset.href;
        if (href) window.open(href, '_blank', 'noopener,noreferrer');
      });
      
      const coverEl = card.querySelector('.venue-cover');
      coverEl?.addEventListener('click', () => {
        if (pickMode) return;
        if (allMediaUrls.length) openGallery(allMediaUrls, 0);
      });
      coverEl && (coverEl.style.cursor = pickMode ? 'pointer' : (allMediaUrls.length ? 'zoom-in' : 'default'));
    }

    function bindSingerCardActions(card, s) {
      const allPhotoUrls = Array.isArray(s.media?.photos) ? s.media.photos.filter(Boolean) : [];
      const allVideoUrls = Array.isArray(s.media?.videos) ? s.media.videos.filter(Boolean) : [];
      const allMediaUrls = [...allPhotoUrls, ...allVideoUrls];
      
      card.querySelector('.singer-repertoire')?.addEventListener('click', () => openRepertoireModal(s));
      card.querySelector('.singer-packages')?.addEventListener('click', () => openPackagesModal(s));
      card.querySelector('.singer-contacts')?.addEventListener('click', () => openContactsModal(s));
      
      const coverEl = card.querySelector('.singer-cover');
      coverEl?.addEventListener('click', () => {
        if (pickMode) return;
        if (allPhotoUrls.length) openGallery(allPhotoUrls, 0);
      });
      coverEl && (coverEl.style.cursor = pickMode ? 'pointer' : (allPhotoUrls.length ? 'zoom-in' : 'default'));
    }

    // === РЕНДЕР КАРТОЧКИ АВТОМОБИЛЯ ===
    function renderCarCard(car) {
      // Получаем фото из media.photos или первый автомобиль в cars
      let coverUrl = null;
      if (Array.isArray(car.media?.photos) && car.media.photos.length) {
        coverUrl = car.media.photos[0];
      } else if (Array.isArray(car.cars) && car.cars.length && car.cars[0].media?.photos?.length) {
        coverUrl = car.cars[0].media.photos[0];
      }
      
      const svgPin = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 22s7-5.33 7-12a7 7 0 10-14 0c0 6.67 7 12 7 12z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.7" fill="none"/>
      </svg>`;
      const svgMoney = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <path d="M7 12h10M12 9v6" stroke="currentColor" stroke-width="1.7" />
      </svg>`;
      const svgCar = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M5 11l2-4h10l2 4M5 11v6h14v-6M5 11H3M19 11h2M7 17v1M17 17v1" stroke="currentColor" stroke-width="1.7"/>
        <circle cx="7" cy="14" r="1.5" fill="currentColor"/>
        <circle cx="17" cy="14" r="1.5" fill="currentColor"/>
      </svg>`;
      
      // Цена из pricing
      let priceText = '';
      if (car.pricing) {
        const base = car.pricing.price?.base;
        const currency = car.pricing.currency || 'AZN';
        const mode = car.pricing.mode || 'hourly';
        if (base && !isNaN(base)) {
          const modeLabel = mode === 'hourly' ? '/час' : mode === 'daily' ? '/день' : '';
          priceText = `${fmt(base)} ${currency}${modeLabel}`;
        }
      }
      
      // Собираем автомобили (первые 3)
      const carsInfo = [];
      if (Array.isArray(car.cars)) {
        car.cars.slice(0, 3).forEach(c => {
          const brand = c.brand || '';
          const model = c.model || '';
          const bodyType = c.body_type || '';
          const year = c.year || '';
          let carLabel = [brand, model].filter(Boolean).join(' ');
          if (bodyType) carLabel += ` (${bodyType})`;
          if (year) carLabel += ` ${year}`;
          if (carLabel) carsInfo.push(carLabel);
        });
      }
      
      const cityText = Array.isArray(car.coverage_cities) && car.coverage_cities.length 
        ? car.coverage_cities.slice(0, 2).join(', ') 
        : '';
      
      return `
        ${coverUrl ? `<img class="img car-cover" src="${coverUrl}" alt="${car.name||''}" loading="lazy">` : `<div class="img car-cover"></div>`}
        <div class="body">
          <div style="margin-bottom:8px">
            <div style="font-weight:600;font-size:18px">${car.name||'Без названия'}</div>
          </div>
          
          <div style="font-size:14px;color:#64748b;display:grid;gap:4px;margin-bottom:10px">
            ${cityText ? `<div style="display:flex;align-items:center;gap:6px;">
              <span style="display:inline-flex;line-height:0;">${svgPin}</span>
              <span>${cityText}</span>
            </div>` : ''}
            ${carsInfo.length ? `<div style="display:flex;align-items:flex-start;gap:6px;">
              <span style="display:inline-flex;line-height:0;margin-top:2px;">${svgCar}</span>
              <span>${carsInfo.join(' • ')}</span>
            </div>` : ''}
          </div>
          
          ${priceText ? `<div style="display:flex;align-items:center;gap:6px;font-size:18px;font-weight:700;color:#2563eb;margin-bottom:10px">
            <span style="display:inline-flex;line-height:0;">${svgMoney}</span>
            <span>${priceText}</span>
          </div>` : ''}
          
          <div class="btns">
            ${Array.isArray(car.cars) && car.cars.length ? `<button class="btn car-details">Детали (${car.cars.length})</button>` : ''}
          </div>
        </div>
      `;
    }

    function bindCarCardActions(card, car) {
      // Собираем все фото
      const allPhotos = [];
      if (Array.isArray(car.media?.photos)) {
        allPhotos.push(...car.media.photos.filter(Boolean));
      }
      if (Array.isArray(car.cars)) {
        car.cars.forEach(c => {
          if (Array.isArray(c.media?.photos)) {
            allPhotos.push(...c.media.photos.filter(Boolean));
          }
        });
      }
      
      card.querySelector('.car-details')?.addEventListener('click', () => openCarDetailsModal(car));
      
      const coverEl = card.querySelector('.car-cover');
      coverEl?.addEventListener('click', () => {
        if (pickMode) return;
        if (allPhotos.length) openGallery(allPhotos, 0);
      });
      coverEl && (coverEl.style.cursor = pickMode ? 'pointer' : (allPhotos.length ? 'zoom-in' : 'default'));
    }

    // ---- РЕНДЕР карточек
    function render(items, meta){
      window.__lastVenues = items;
      window.__lastMeta   = meta || null;

      console.log(`🎨 Rendering ${items.length} items for catalog: ${activeCatalog}`);
      
      $grid.innerHTML = '';
      $status.innerHTML = '';
      if (meta?.note || meta?.expires_at) {
        const note = document.createElement('div');
        note.className = 'note';
        note.textContent = `${meta?.note ? 'Комментарий: '+meta.note+'. ' : ''}${meta?.expires_at ? 'Действует до '+new Date(meta.expires_at).toLocaleString() : ''}`;
        $status.appendChild(note);
      }
      if (!items.length) { $empty.style.display='block'; return; }
      $empty.style.display='none';

      let renderedCount = 0;
      for (const item of items) {
        try {
          let cardHtml = '';
          
          if (activeCatalog === 'venues') {
            cardHtml = renderVenueCard(item);
          } else if (activeCatalog === 'singers') {
            cardHtml = renderSingerCard(item);
          } else if (activeCatalog === 'cars') {
            cardHtml = renderCarCard(item);
          }
          
          if (!cardHtml) {
            console.warn(`⚠️ Empty card HTML for ${activeCatalog} ${item.id}`);
            continue;
          }
          
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = cardHtml;

          // выбор
          if (pickMode) {
            const dot = document.createElement('div');
            dot.className = 'select-dot';
            dot.textContent = selected.has(item.id) ? '✓' : '';
            dot.addEventListener('click', (e)=>{
              e.stopPropagation();
              if (selected.has(item.id)) selected.delete(item.id); else selected.add(item.id);
              dot.textContent = selected.has(item.id) ? '✓' : '';
              card.classList.toggle('sel', selected.has(item.id));
              $selCount.textContent = 'Выбрано: ' + selected.size;
              $genBtn.disabled = selected.size === 0;
            });
            const wrap = document.createElement('div');
            wrap.className = 'card-wrap';
            wrap.appendChild(card);
            wrap.appendChild(dot);
            $grid.appendChild(wrap);
          } else {
            $grid.appendChild(card);
          }

          // Bind card actions
          if (activeCatalog === 'venues') {
            bindVenueCardActions(card, item);
          } else if (activeCatalog === 'singers') {
            bindSingerCardActions(card, item);
          } else if (activeCatalog === 'cars') {
            bindCarCardActions(card, item);
          }

          // подсветка выбранных
          card.classList.toggle('sel', selected.has(item.id));
          
          renderedCount++;
        } catch (error) {
          console.error(`❌ Error rendering ${activeCatalog} ${item.id}:`, error);
          console.error('Item data:', item);
        }
      }
      
      console.log(`✅ Successfully rendered ${renderedCount} out of ${items.length} cards`);
    }

    // ---- ЗАГРУЗКА ДАННЫХ
    async function loadCatalogData(catalog) {
      const config = CATALOG_CONFIG[catalog];
      if (!config) return;
      
      $status.textContent = 'Загрузка данных из Firebase…';
      const collectionName = config.collection;
      console.log(`Loading catalog: ${catalog}, collection: ${collectionName}`);
      
      const snap = await getDocs(collection(db, collectionName));
      const items = [];
      let skippedCount = 0;
      
      for (const d of snap.docs) {
        const data = d.data();
        // Для певцов фильтруем только published
        if (catalog === 'singers' && data.status !== 'published') {
          console.log(`❌ Skipping singer ${d.id}: status = "${data.status}" (not "published")`);
          skippedCount++;
          continue;
        }
        
        const item = { id: d.id, ...data };
        
        // Для певцов загружаем pricing_packages из субколлекции
        if (catalog === 'singers') {
          try {
            const packagesSnap = await getDocs(collection(db, 'singers', d.id, 'pricing_packages'));
            item._pricing_packages = [];
            packagesSnap.forEach(pkgDoc => {
              item._pricing_packages.push({ id: pkgDoc.id, ...pkgDoc.data() });
            });
            console.log(`✅ Adding singer ${d.id}: ${item._pricing_packages.length} packages`);
          } catch (err) {
            console.warn(`⚠️ Failed to load packages for singer ${d.id}:`, err);
            item._pricing_packages = [];
          }
        } else {
          console.log(`✅ Adding ${catalog} ${d.id}`);
        }
        
        items.push(item);
      }
      
      console.log(`Loaded ${items.length} items for catalog ${catalog} (skipped: ${skippedCount})`);
      $status.textContent = items.length === 0 ? `Нет данных в каталоге ${config.title}` : '';

      // ВАЖНО: всегда обновляем _allVenues, даже если items пустой
      _allVenues = items.slice();
      _viewVenues = [];
      
      // Populate dynamic filters ПЕРЕД restoreFiltersFromURL
      if (catalog === 'venues') {
        populateDistricts(_allVenues);
      } else if (catalog === 'singers') {
        populateCities(_allVenues);
        populateGenres(_allVenues);
        populateLanguages(_allVenues);
      } else if (catalog === 'cars') {
        populateBodyTypes(_allVenues);
        populateBrands(_allVenues);
        populateCarCities(_allVenues);
      }
      
      // Restore filters from URL (теперь элементы уже существуют)
      restoreFiltersFromURL();
      
      // Bind events
      bindFilterEventsOnce();
      
      // Apply filters and render
      applyFilters();
    }

    async function loadShortlist(catalog, slug, token) {
      const config = CATALOG_CONFIG[catalog];
      if (!config) return;
      
      $status.textContent = 'Загрузка персонального шортлиста…';
      const sDoc = await getDoc(doc(db, config.shortlistCollection, slug));
      if (!sDoc.exists()) { $status.textContent = 'Шортлист не найден'; return; }
      const sData = sDoc.data();
      
      // Check token
      if (sData.token && sData.token !== token) { $status.textContent = 'Неверный токен'; return; }
      if (sData.token_hash) {
        const h = await sha256Hex(token || '');
        if (h !== sData.token_hash) { $status.textContent = 'Неверный токен'; return; }
      }
      
      // Check expiration
      const exp = sData.expires_at?.toDate ? sData.expires_at.toDate() : (sData.expires_at ? new Date(sData.expires_at) : null);
      if (exp && exp < new Date()) { $status.textContent = 'Ссылка истекла'; return; }

      // Load items by IDs
      const ids = catalog === 'singers' ? (sData.singer_ids || []) 
                : catalog === 'cars' ? (sData.car_ids || []) 
                : (sData.venue_ids || []);
      const items = [];
      for (const id of ids) {
        const itemDoc = await getDoc(doc(db, config.collection, id));
        if (itemDoc.exists()) {
          const data = itemDoc.data();
          // Для певцов проверяем status
          if (catalog === 'singers' && data.status !== 'published') continue;
          items.push({ id: itemDoc.id, ...data });
        }
      }
      $status.textContent = '';

      _allVenues = items.slice();
      
      // Populate dynamic filters
      if (catalog === 'venues') {
        populateDistricts(_allVenues);
      } else if (catalog === 'singers') {
        populateCities(_allVenues);
        populateGenres(_allVenues);
        populateLanguages(_allVenues);
      } else if (catalog === 'cars') {
        populateBodyTypes(_allVenues);
        populateBrands(_allVenues);
        populateCarCities(_allVenues);
      }
      
      restoreFiltersFromURL();
      bindFilterEventsOnce();
      applyFilters();
    }

    // ---- Генерация ссылки (через модалку настроек)
    $genBtn?.addEventListener('click', () => {
      if (!selected.size) return;
      $cfgExpire.value = '7';
      $cfgDateWrap.style.display = 'none';
      $cfgSlug.value = '';
      $cfgNote.value = 'Подбор от ' + new Date().toLocaleString();
      openCfg();
    });

    $cfgCreate?.addEventListener('click', async () => {
      if (!selected.size) return;
      let slug = ($cfgSlug.value || '').trim().toLowerCase();
      if (!slug) slug = Math.random().toString(36).slice(2,8);
      if (!/^[a-z0-9-]{3,50}$/.test(slug)) { alert('Slug: латиница/цифры/дефисы (3–50).'); return; }

      let expiresAt;
      if ($cfgExpire.value === 'custom') {
        if (!$cfgDate.value) { alert('Укажите дату/время истечения.'); return; }
        expiresAt = new Date($cfgDate.value);
      } else {
        const days = parseInt($cfgExpire.value, 10) || 7;
        expiresAt = new Date(Date.now() + days*24*60*60*1000);
      }

      const ids   = Array.from(selected);
      const token = Math.random().toString(36).slice(2,10);
      const note  = $cfgNote.value?.trim() || null;
      
      const config = CATALOG_CONFIG[activeCatalog];
      const idField = activeCatalog === 'singers' ? 'singer_ids' : 'venue_ids';

      try {
        const docData = {
          [idField]: ids,
          token_hash: await sha256Hex(token),
          note,
          created_at: serverTimestamp(),
          expires_at: expiresAt
        };
        
        await setDoc(doc(db, config.shortlistCollection, slug), docData);
        closeCfg();

        const params = new URLSearchParams();
        params.set('catalog', activeCatalog);
        params.set('shortlist', slug);
        params.set('token', token);
        const url = `${location.origin}/?${params.toString()}`;
        
        lastGeneratedUrl = url;
        ($shareBox || {}).style.display = 'inline-flex';
        const enc = encodeURIComponent(url);
        if ($waBtn) $waBtn.href = `https://wa.me/?text=${enc}`;
        if ($tgBtn) $tgBtn.href = `https://t.me/share/url?url=${enc}`;

        const copied = await copyToClipboard(url);
        if (copied) showToast('Скопировано'); else alert('Ссылка:\n' + url);
        if (navigator.share) { try { await navigator.share({ title:'Подбор', url }); } catch {} }
      } catch (e) {
        console.error(e);
        alert('Не удалось создать ссылку: ' + (e?.message || e));
      }
    });

    // ---- Старт — решаем, что грузить
    const qs = new URLSearchParams(location.search);
    const catalogParam = qs.get('catalog') || 'venues';
    const shortlistSlug  = qs.get('shortlist');
    const shortlistToken = qs.get('token');
    
    // Set active catalog
    activeCatalog = CATALOG_CONFIG[catalogParam] ? catalogParam : 'venues';
    
    // Initialize UI
    document.querySelectorAll('.catalog-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.catalog === activeCatalog);
    });
    $pageTitle.textContent = CATALOG_CONFIG[activeCatalog].title;
    buildFilters(activeCatalog);
    
    try {
      if (shortlistSlug && shortlistToken) {
        await loadShortlist(activeCatalog, shortlistSlug, shortlistToken);
      } else {
        await loadCatalogData(activeCatalog);
      }
    } catch (e) {
      console.error(e);
      $status.textContent = 'Ошибка загрузки: ' + (e?.message || e);
    }
  });
</script>
</body>
</html>
