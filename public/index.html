<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Картотека площадок</title>

  <!-- firebaseConfig -->
  <script>
    window.__FIREBASE_CONFIG__ = {
      apiKey: "AIzaSyANblr6MInsVbY9LnN3OUHNA5Ri2ttPHCo",
      authDomain: "ai-event-bot.firebaseapp.com",
      databaseURL: "https://ai-event-bot-default-rtdb.firebaseio.com",
      projectId: "ai-event-bot",
      storageBucket: "ai-event-bot.firebasestorage.app",
      messagingSenderId: "884896771261",
      appId: "1:884896771261:web:b60d950938a924a71a5bd4",
      measurementId: "G-4H9BVWN184"
    };
    window.__FIREBASE_COLLECTIONS__ = { venues: "venues", shortlists: "shortlists" };
  </script>

  <!-- БАЗОВЫЕ СТИЛИ СТРАНИЦЫ -->
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --txt:#0f172a; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 4px;font-size:28px}
    .sub{color:var(--muted);margin:0 0 16px}
    .status{margin:8px 0 16px;font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 1px 3px rgb(0 0 0 / 0.05)}
    .img{height:180px;background:#eee;display:block;width:100%;object-fit:cover}
    .body{padding:14px}
    .row{display:flex;justify-content:space-between;gap:12px}
    .loc{color:var(--muted);font-size:14px}
    .p{margin:8px 0 0;color:#334155;font-size:14px;line-height:1.35}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--border);background:white;border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#fafafa}
    .footer{margin:24px 0 12px;color:var(--muted);font-size:12px;text-align:center}
    .note{font-size:12px;color:var(--muted)}
    .inp{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    @media (max-width:900px){ #filters{grid-template-columns:1fr 1fr; } }
  </style>

  <!-- СТИЛИ МОДАЛКИ ГАЛЕРЕИ -->
  <style>
    .gallery-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:50}
    .gallery-backdrop.show{display:flex}
    .gallery-wrap{max-width:min(1200px,96vw);max-height:90vh;display:flex;flex-direction:column;gap:10px}
    .gallery-stage{position:relative;background:#000;border-radius:12px;overflow:hidden}
    .gallery-img{max-width:96vw;max-height:70vh;display:block;margin:0 auto}
    .gallery-close,.gallery-prev,.gallery-next{
      position:absolute;top:10px;border:none;background:rgba(255,255,255,.15);color:#fff;
      width:40px;height:40px;border-radius:999px;cursor:pointer;font-size:18px;backdrop-filter:blur(2px)
    }
    .gallery-close{right:10px}
    .gallery-prev{left:10px;top:50%;transform:translateY(-50%)}
    .gallery-next{right:10px;top:50%;transform:translateY(-50%)}
    .gallery-strip{display:flex;gap:8px;overflow-x:auto;padding:6px;background:#0b0b0b;border-radius:12px}
    .gallery-thumb{width:80px;height:60px;object-fit:cover;border-radius:8px;opacity:.6;border:2px solid transparent;cursor:pointer}
    .gallery-thumb.active{opacity:1;border-color:#fff}

    .select-dot{
      position:absolute;top:10px;left:10px;width:22px;height:22px;border-radius:999px;
      border:2px solid #fff;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:14px;cursor:pointer;user-select:none
    }
    .card.sel{outline:2px solid #2563eb}
    .card-wrap{position:relative}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Картотека площадок</h1>
      <div id="toolbar" style="display:flex;gap:10px;align-items:center;margin:10px 0 16px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center;">
          <input id="modeToggle" type="checkbox">
          <span>Режим подбора</span>
        </label>
      
        <button id="genBtn" type="button" class="btn" disabled>Сгенерировать ссылку</button>
      
        <!-- Блок шаринга появляется после генерации -->
        <span id="shareBox" style="display:none;gap:8px;align-items:center;">
          <button id="copyBtn" type="button" class="btn">Скопировать</button>
          <a id="waBtn" class="btn" target="_blank" rel="noreferrer">WhatsApp</a>
          <a id="tgBtn" class="btn" target="_blank" rel="noreferrer">Telegram</a>
        </span>
      
        <span id="selCount" style="color:#6b7280;font-size:14px">Выбрано: 0</span>
      </div>

    <div id="filters" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;margin:8px 0 16px">
      <input id="fSearch" type="text" placeholder="Поиск: название, район, теги…" class="inp">
      <select id="fDistrict" class="inp"><option value="">Все районы</option></select>
      <input id="fCap" type="text" placeholder="Вместимость: 100-300" class="inp">
      <input id="fPrice" type="text" placeholder="Цена/гость: 20-100" class="inp">
    </div>

    <p class="sub">Список площадок с Firebase. Персональная ссылка поддерживает <code>?shortlist=SLUG&token=TOKEN</code>.</p>
    <div id="status" class="status"></div>
    <div id="grid" class="grid"></div>
    <div id="empty" style="display:none;color:#9ca3af;text-align:center;padding:40px 0">Ничего не найдено.</div>
    <div class="footer">Demo: данные из Firestore. Медиа отображаются по URL.</div>
  </div>
  
  <!-- Gallery modal -->
  <div id="gallery" class="gallery-backdrop" aria-hidden="true">
    <div class="gallery-wrap">
      <div class="gallery-stage">
        <img id="gallery-img" class="gallery-img" alt="">
        <button id="gallery-close" class="gallery-close" title="Закрыть">✕</button>
        <button id="gallery-prev"  class="gallery-prev"  title="Назад">❮</button>
        <button id="gallery-next"  class="gallery-next  title="Вперёд">❯</button>
      </div>
      <div id="gallery-strip" class="gallery-strip"></div>
    </div>
  </div>

  <div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
  background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:60">
    Скопировано
  </div>

  <!-- Link Config Modal -->
  <div id="linkConfig" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:70">
    <div style="background:#fff;border-radius:16px;max-width:520px;width:92vw;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:700;font-size:18px">Параметры ссылки</div>
        <button id="cfgClose" type="button" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer">✕</button>
      </div>
  
      <div style="display:grid;gap:12px">
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">Срок действия</span>
          <select id="cfgExpire" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px">
            <option value="7">7 дней</option>
            <option value="14">14 дней</option>
            <option value="30">30 дней</option>
            <option value="custom">Указать дату</option>
          </select>
        </label>
  
        <label id="cfgDateWrap" style="display:none;gap:6px">
          <span style="font-size:14px;color:#475569;margin-right:8px">Дата и время (локальные)</span>
          <input id="cfgDate" type="datetime-local" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
        </label>
  
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">Идентификатор (slug, латиница/цифры/дефисы)</span>
          <input id="cfgSlug" type="text" placeholder="например, ivanov-1016"
                 style="padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
        </label>
  
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">Заметка клиенту (необязательно)</span>
          <textarea id="cfgNote" rows="3" placeholder="Например: Под вашу дату есть спецусловия"
                    style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;resize:vertical"></textarea>
        </label>
      </div>
  
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
        <button id="cfgCancel" type="button" class="btn">Отмена</button>
        <button id="cfgCreate" type="button" class="btn">Создать ссылку</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, getDocs, getDoc, doc,
      setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  
    // === CONFIG ===
    const CFG = window.__FIREBASE_CONFIG__;
    const COL = (window.__FIREBASE_COLLECTIONS__ || { venues:"venues", shortlists:"shortlists" });

    // === refs для фильтров (объявляем заранее!)
    let $fSearch, $fDistrict, $fCap, $fPrice;
    
    // === GLOBALS ===
    let db, auth;
    let pickMode = false;
    const selected = new Set();
    let lastGeneratedUrl = "";
    let touchStartX = null;
  
    // сохранённые для «мягкой» перерисовки
    window.__lastVenues = [];
    window.__lastMeta   = null;
  
    // утилиты
    const fmt = (n) => new Intl.NumberFormat('ru-RU').format(n);
    const sha256Hex = async (text) => {
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    };
    
    function normalizeMedia(m) {
      if (!m) return [];
      if (Array.isArray(m)) {
        return m.flatMap(x => {
          if (typeof x === 'string') return [{ type:'image', url:x }];
          if (x && typeof x === 'object') {
            const url = x.url || x.src || x.image || x.link;
            return url ? [{ type: x.type || 'image', url }] : [];
          }
          return [];
        });
      }
      if (typeof m === 'string') return [{ type:'image', url:m }];
      if (typeof m === 'object') {
        const out = [];
        const pushArr = (arr, typeGuess='image') => {
          if (!Array.isArray(arr)) return;
          arr.forEach(v => {
            if (typeof v === 'string') out.push({ type:typeGuess, url:v });
            else if (v && typeof v === 'object') {
              const url = v.url || v.src || v.image || v.link;
              if (url) out.push({ type: v.type || typeGuess, url });
            }
          });
        };
        pushArr(m.photos || m.images || m.pictures, 'image');
        pushArr(m.videos || m.video, 'video');
        if (!out.length) {
          const url = m.url || m.src || m.image || m.link;
          if (url) out.push({ type:m.type || 'image', url });
        }
        return out;
      }
      return [];
    }

    let filtersBound = false;

    /*
    function bindFilterEventsOnce() {
      if (filtersBound) return;
      filtersBound = true;
      // debounce можно свой, если уже есть — используй его
      const debounce = (fn, ms=200) => {
        let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
      };
    
      $fSearch.addEventListener('input', debounce(applyFilters, 200));
      [$fDistrict, $fCap, $fPrice].forEach(el =>
        el.addEventListener('input', applyFilters)
      );
    }
    */
    function bindFilterEventsOnce(){
      if(filtersBound || !$fSearch) return;
      filtersBound = true;
      const debounce = (fn,ms=200)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
      $fSearch.addEventListener('input', debounce(applyFilters,200));
      [$fDistrict,$fCap,$fPrice].forEach(el=> el.addEventListener('input', applyFilters));
    }
    
    // ждём DOM — тут мы берём все элементы и вешаем обработчики
    window.addEventListener('DOMContentLoaded', async () => {
      // Firebase
      const app = initializeApp(CFG);
      db   = getFirestore(app);
      auth = getAuth(app);
      signInAnonymously(auth).catch(console.error);
  
      // DOM refs
      const $status    = document.getElementById('status') || {textContent:''};
      const $grid      = document.getElementById('grid');
      const $empty     = document.getElementById('empty');
      const $modeToggle= document.getElementById('modeToggle');
      const $genBtn    = document.getElementById('genBtn');
      const $selCount  = document.getElementById('selCount');
      const $shareBox  = document.getElementById('shareBox');
      const $copyBtn   = document.getElementById('copyBtn');
      const $waBtn     = document.getElementById('waBtn');
      const $tgBtn     = document.getElementById('tgBtn');
      const $toast     = document.getElementById('toast');
  
      // Галерея (элементы уже есть внизу body)
      const $g      = document.getElementById('gallery');
      const $gImg   = document.getElementById('gallery-img');
      const $gStrip = document.getElementById('gallery-strip');
      const $gPrev  = document.getElementById('gallery-prev');
      const $gNext  = document.getElementById('gallery-next');
      const $gClose = document.getElementById('gallery-close');
      let galleryUrls = [];
      let galleryIndex = 0;
      /*
      const $fSearch = document.getElementById('fSearch');
      const $fDistrict = document.getElementById('fDistrict');
      const $fCap = document.getElementById('fCap');
      const $fPrice = document.getElementById('fPrice');
      */
      $fSearch   = document.getElementById('fSearch');
      $fDistrict = document.getElementById('fDistrict');
      $fCap      = document.getElementById('fCap');
      $fPrice    = document.getElementById('fPrice');
      
      let _allVenues = [];   // полный список
      let _viewVenues = [];  // после фильтрации

      // link-config modal
      const $cfg     = document.getElementById('linkConfig');
      const $cfgClose= document.getElementById('cfgClose');
      const $cfgCancel= document.getElementById('cfgCancel');
      const $cfgCreate= document.getElementById('cfgCreate');
      const $cfgExpire= document.getElementById('cfgExpire');
      const $cfgDateWrap= document.getElementById('cfgDateWrap');
      const $cfgDate = document.getElementById('cfgDate');
      const $cfgSlug = document.getElementById('cfgSlug');
      const $cfgNote = document.getElementById('cfgNote');
      
      function openCfg() { $cfg.style.display='flex'; }
      function closeCfg(){ $cfg.style.display='none'; }
      
      $cfgClose?.addEventListener('click', closeCfg);
      $cfgCancel?.addEventListener('click', closeCfg);
      $cfg.addEventListener('click', (e)=>{ if(e.target===$cfg) closeCfg(); });
      
      $cfgExpire?.addEventListener('change', ()=>{
        $cfgDateWrap.style.display = ($cfgExpire.value === 'custom') ? 'grid' : 'none';
      });

      function renderGallery(){
        $gImg.src = galleryUrls[galleryIndex];
        $gStrip.innerHTML = '';
        galleryUrls.forEach((u,i)=>{
          const img = document.createElement('img');
          img.className = 'gallery-thumb' + (i===galleryIndex ? ' active' : '');
          img.src = u;
          img.addEventListener('click', ()=>{ galleryIndex=i; renderGallery(); });
          $gStrip.appendChild(img);
        });
      }
      
      function openGallery(urls, startIdx=0){
        galleryUrls = urls.filter(Boolean);
        if (!galleryUrls.length) return;
        galleryIndex = Math.min(Math.max(0, startIdx), galleryUrls.length-1);
        renderGallery();
        $g.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
      
      function closeGallery(){
        $g.classList.remove('show');
        document.body.style.overflow = '';
      }
      $gNext?.addEventListener('click', ()=>{ galleryIndex=(galleryIndex+1)%galleryUrls.length; renderGallery(); });
      $gPrev?.addEventListener('click', ()=>{ galleryIndex=(galleryIndex-1+galleryUrls.length)%galleryUrls.length; renderGallery(); });
      $gClose?.addEventListener('click', closeGallery);
      $g?.addEventListener('click', (e)=>{ if(e.target===$g) closeGallery(); });
      window.addEventListener('keydown', (e)=>{
        if(!$g.classList.contains('show')) return;
        if(e.key==='Escape') closeGallery();
        if(e.key==='ArrowRight') $gNext.click();
        if(e.key==='ArrowLeft')  $gPrev.click();
      });
      $g?.addEventListener('touchstart', (e)=>{ touchStartX = e.changedTouches[0].clientX; }, {passive:true});
      $g?.addEventListener('touchend', (e)=>{
        if(touchStartX==null) return;
        const dx = e.changedTouches[0].clientX - touchStartX;
        if(Math.abs(dx) > 40) { dx<0 ? $gNext.click() : $gPrev.click(); }
        touchStartX = null;
      }, {passive:true});
  
      // тост + копирование
      function showToast(text='Скопировано') {
        if (!$toast) return;
        $toast.textContent = text;
        $toast.style.opacity = '1';
        setTimeout(()=> $toast.style.opacity = '0', 1400);
      }
      
      async function copyToClipboard(text) {
        try { await navigator.clipboard.writeText(text); return true; } catch{}
        try {
          const ta = document.createElement('textarea');
          ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
          document.body.appendChild(ta); ta.select();
          const ok = document.execCommand('copy'); document.body.removeChild(ta);
          return ok;
        } catch { return false; }
      }
      
      $copyBtn?.addEventListener('click', async () => {
        if (!lastGeneratedUrl) { alert('Сначала сгенерируйте ссылку.'); return; }
        const ok = await copyToClipboard(lastGeneratedUrl);
        showToast(ok ? 'Скопировано' : 'Скопируйте вручную');
      });
  
      // режим подбора
      function rerender(){ render(window.__lastVenues, window.__lastMeta); }
      $modeToggle?.addEventListener('change', ()=>{
        pickMode = $modeToggle.checked;
        selected.clear();
        $selCount.textContent = 'Выбрано: 0';
        $genBtn.disabled = true;
        $shareBox.style.display = 'none';
        lastGeneratedUrl = '';
        rerender();
      });

      function parseRange(text){
        if(!text) return [null,null];
        const m = (text.replace(/\s/g,'').match(/^(\d+)?-?(\d+)?$/) || []);
        /*
        const lo = m[1] ? +m[1] : null;
        const hi = m[2] ? +m[2] : null;
        return [lo, hi];
        */
        return [m[1]?+m[1]:null, m[2]?+m[2]:null];
      }
      
      function strIncludes(hay, needle){
        return hay.toLowerCase().includes(needle.toLowerCase());
      }
      /*
      function applyFilters(){
        if(!$fSearch) return;                       // на всякий случай
        const q = ($fSearch.value||'').trim();
        const dist = $fDistrict.value||'';
        const [capLo, capHi]   = parseRange(($fCap.value||'').trim());
        const [priceLo,priceHi]= parseRange(($fPrice.value||'').trim());
      
        _viewVenues = _allVenues.filter(v=>{
          // поиск
          if(q){
            const hay = [
              v.name, v.city, v.district,
              (v.tags||[]).join(' '),
              v.description
            ].filter(Boolean).join(' ').toLowerCase();
            if(!hay.includes(q.toLowerCase())) return false;
          }
          // район
          if(dist && v.district !== dist) return false;
      
          // вместимость (пересечение диапазонов)
          if(capLo!=null || capHi!=null){
            const vLo = +v.capacity_min || 0, vHi = +v.capacity_max || 0;
            if(capLo!=null && vHi < capLo) return false;
            if(capHi!=null && vLo > capHi) return false;
          }
          // цена/гость
          if(priceLo!=null || priceHi!=null){
            const pLo = +v.price_min || 0, pHi = +v.price_max || 0;
            if(priceLo!=null && pHi < priceLo) return false;
            if(priceHi!=null && pLo > priceHi) return false;
          }
          return true;
        });
      
        // отрисовываем
        render(_viewVenues, window.__lastMeta);
      
        // синхронизируем URL
        const params = new URLSearchParams(location.search);
        q ? params.set('q', q) : params.delete('q');
        dist ? params.set('d', dist) : params.delete('d');
        $fCap.value ? params.set('cap', $fCap.value.trim()) : params.delete('cap');
        $fPrice.value ? params.set('price', $fPrice.value.trim()) : params.delete('price');
        const newUrl = `${location.pathname}?${params.toString()}`;
        history.replaceState(null,'',newUrl);
      }
      */

      function applyFilters(){
        if(!$fSearch) return;                       // на всякий случай
        const q = ($fSearch.value||'').trim().toLowerCase();
        const dist = $fDistrict.value||'';
        const [capLo,capHi]     = parseRange(($fCap.value||'').trim());
        const [priceLo,priceHi] = parseRange(($fPrice.value||'').trim());
      
        _viewVenues = _allVenues.filter(v=>{
          if(q){
            const hay = [v.name,v.city,v.district,(v.tags||[]).join(' '),v.description]
                        .filter(Boolean).join(' ').toLowerCase();
            if(!hay.includes(q)) return false;
          }
          if(dist && v.district!==dist) return false;
      
          if(capLo!=null || capHi!=null){
            const vLo = +v.capacity_min||0, vHi = +v.capacity_max||0;
            if(capLo!=null && vHi<capLo) return false;
            if(capHi!=null && vLo>capHi) return false;
          }
          if(priceLo!=null || priceHi!=null){
            const pLo = +v.price_min||0, pHi = +v.price_max||0;
            if(priceLo!=null && pHi<priceLo) return false;
            if(priceHi!=null && pLo>priceHi) return false;
          }
          return true;
        });
      
        render(_viewVenues, window.__lastMeta);
      
        // синхронизация в URL
        const params = new URLSearchParams(location.search);
        q ? params.set('q', q) : params.delete('q');
        dist ? params.set('d', dist) : params.delete('d');
        $fCap.value   ? params.set('cap', $fCap.value.trim())     : params.delete('cap');
        $fPrice.value ? params.set('price', $fPrice.value.trim()) : params.delete('price');
        const newUrl = `${location.pathname}?${params.toString()}`;
        history.replaceState(null,'',newUrl);
      }
      
      // РЕНДЕР
      function render(venues, meta){
        window.__lastVenues = venues;
        window.__lastMeta   = meta || null;
  
        $grid.innerHTML = '';
        $status.innerHTML = '';
        if (meta?.note || meta?.expires_at) {
          const note = document.createElement('div');
          note.className = 'note';
          note.textContent = `${meta?.note ? 'Комментарий: '+meta.note+'. ' : ''}${meta?.expires_at ? 'Действует до '+new Date(meta.expires_at).toLocaleString() : ''}`;
          $status.appendChild(note);
        }
        if (!venues.length) { $empty.style.display='block'; return; }
        $empty.style.display='none';
  
        for (const v of venues) {
          // обложка
          let coverUrl = Array.isArray(v.media?.photos) && v.media.photos.length ? v.media.photos[0] : null;
          const mediaArr = normalizeMedia(v.media);
          if (!coverUrl && mediaArr.length) coverUrl = mediaArr[0]?.url || null;
  
          const allPhotoUrls = Array.isArray(v.media?.photos) ? v.media.photos.filter(Boolean) : [];
          const fallbackUrls = mediaArr.map(m => m?.url).filter(Boolean);
          const allMediaUrls = Array.from(new Set([...allPhotoUrls, ...fallbackUrls]));
  
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            ${coverUrl ? `<img class="img" src="${coverUrl}" alt="${v.name||''}" loading="lazy">` : `<div class="img"></div>`}
            <div class="body">
              <div class="row">
                <div>
                  <div style="font-weight:600;font-size:18px">${v.name||''}</div>
                  <div class="loc">${[v.city, v.district].filter(Boolean).join(', ')}</div>
                </div>
                <div style="text-align:right;font-size:14px;color:#475569">
                  ${
                    (Number.isFinite(v.price_min) && Number.isFinite(v.price_max))
                    ? `от ${fmt(v.price_min)} – до ${fmt(v.price_max)} ${v.currency||''}` : ''
                  }<br>
                  ${
                    (Number.isFinite(v.capacity_min) && Number.isFinite(v.capacity_max))
                    ? `${fmt(v.capacity_min)}–${fmt(v.capacity_max)}` : ''
                  }
                </div>
              </div>
              ${v.description ? `<p class="p">${v.description}</p>` : ''}
              <div class="btns">
                ${allMediaUrls.length ? `<button class="btn" data-action="media">Медиа</button>` : ''}
                ${v.location_url ? `<a class="btn" href="${v.location_url}" target="_blank" rel="noreferrer">Карта</a>` : ''}
              </div>
            </div>
          `;
  
          // выбор
          if (pickMode) {
            const dot = document.createElement('div');
            dot.className = 'select-dot';
            dot.textContent = selected.has(v.id) ? '✓' : '';
            dot.addEventListener('click', (e)=>{
              e.stopPropagation();
              if (selected.has(v.id)) selected.delete(v.id); else selected.add(v.id);
              dot.textContent = selected.has(v.id) ? '✓' : '';
              card.classList.toggle('sel', selected.has(v.id));
              $selCount.textContent = 'Выбрано: ' + selected.size;
              $genBtn.disabled = selected.size === 0;
            });
            const wrap = document.createElement('div');
            wrap.className = 'card-wrap';
            wrap.appendChild(card);
            wrap.appendChild(dot);
            $grid.appendChild(wrap);
          } else {
            $grid.appendChild(card);
          }
  
          // кнопка Медиа
          const mediaBtn = card.querySelector('[data-action="media"]');
          mediaBtn?.addEventListener('click', () => openGallery(allMediaUrls, 0));
  
          // клик по обложке
          const coverEl = card.querySelector('.img');
          coverEl?.addEventListener('click', () => {
            if (pickMode) return;
            if (allMediaUrls.length) openGallery(allMediaUrls, 0);
          });
          coverEl && (coverEl.style.cursor = pickMode ? 'pointer' : (allMediaUrls.length ? 'zoom-in' : 'default'));
  
          // подсветка выбранных
          card.classList.toggle('sel', selected.has(v.id));
        }
      }

      function populateDistricts(list){
        if(!$fDistrict) return;
        const districts = Array.from(new Set(list.map(v=>v.district).filter(Boolean))).sort();
        $fDistrict.innerHTML =
          '<option value="">Все районы</option>' +
          districts.map(d=>`<option value="${d}">${d}</option>`).join('');
      }
      
      function restoreFiltersFromURL(){
        if(!$fSearch) return;
        const ps = new URLSearchParams(location.search);
        $fSearch.value  = ps.get('q')    || '';
        $fDistrict.value= ps.get('d')    || '';
        $fCap.value     = ps.get('cap')  || '';
        $fPrice.value   = ps.get('price')|| '';
      }

      // ЗАГРУЗКА ДАННЫХ
      async function loadAllVenues() {
        $status.textContent = 'Загрузка данных из Firebase…';
        const snap = await getDocs(collection(db, COL.venues));
        const venues = [];
        snap.forEach(d => venues.push({ id: d.id, ...d.data() }));
        $status.textContent = '';

        const districts = Array.from(new Set(venues.map(v=>v.district).filter(Boolean))).sort();
        $fDistrict.innerHTML = '<option value="">Все районы</option>' + districts.map(d=>`<option>${d}</option>`).join('');
        
        // восстановим фильтры из URL
        const ps = new URLSearchParams(location.search);
        $fSearch.value = ps.get('q') || '';
        $fDistrict.value = ps.get('d') || '';
        $fCap.value = ps.get('cap') || '';
        $fPrice.value = ps.get('price') || '';
        
        // сохраним полный список и применим фильтр
        _allVenues = venues.slice();
        populateDistricts(_allVenues);
        restoreFiltersFromURL();
        bindFilterEventsOnce();     // <-- ВАЖНО
        applyFilters();
        
        // события
        $fSearch.addEventListener('input', debounce(applyFilters, 200));
        [$fDistrict,$fCap,$fPrice].forEach(el => el.addEventListener('input', applyFilters));

        render(venues);
      }
      
      async function loadShortlist(slug, token) {
        $status.textContent = 'Загрузка персонального шортлиста…';
        const sDoc = await getDoc(doc(db, COL.shortlists, slug));
        if (!sDoc.exists()) { $status.textContent = 'Шортлист не найден'; return; }
        const sData = sDoc.data();
        if (sData.token && sData.token !== token) { $status.textContent = 'Неверный токен'; return; }
        if (sData.token_hash) {
          const h = await sha256Hex(token || '');
          if (h !== sData.token_hash) { $status.textContent = 'Неверный токен'; return; }
        }
        const exp = sData.expires_at?.toDate ? sData.expires_at.toDate() : (sData.expires_at ? new Date(sData.expires_at) : null);
        if (exp && exp < new Date()) { $status.textContent = 'Ссылка истекла'; return; }
        const ids = Array.isArray(sData.venue_ids) ? sData.venue_ids : [];
        const venues = [];
        for (const id of ids) {
          const v = await getDoc(doc(db, COL.venues, id));
          if (v.exists()) venues.push({ id: v.id, ...v.data() });
        }
        
        $status.textContent = '';
        
        _allVenues = venues.slice();            // <- источник для фильтров = подмножество шортлиста
        populateDistricts(_allVenues);          // <- опции районов именно по выбранным площадкам
        restoreFiltersFromURL();                // <- восстановим q/d/cap/price из URL (если есть)
        window.__lastMeta = {                   // <- чтобы render показывал заметку и срок
          note: sData.note,
          expires_at: exp?.toISOString()
        };
        bindFilterEventsOnce();                              // <-- ВАЖНО
        applyFilters();                         // <- запускаем фильтрацию и отрисовку

        render(venues, { note: sData.note, expires_at: exp?.toISOString() });
      }
  
      // Генерация ссылки
      /*
      $genBtn?.addEventListener('click', async () => {
        if (!selected.size) return;
        const ids = Array.from(selected);
        const slug  = Math.random().toString(36).slice(2, 8);
        const token = Math.random().toString(36).slice(2, 10);
        const expiresAt = new Date(Date.now() + 7*24*60*60*1000);
        await setDoc(doc(db, COL.shortlists, slug), {
          venue_ids: ids,
          token_hash: await sha256Hex(token),
          note: 'Подбор от ' + new Date().toLocaleString(),
          created_at: serverTimestamp(),
          expires_at: expiresAt
        });
        const url = `${location.origin}/?shortlist=${slug}&token=${token}`;
        lastGeneratedUrl = url;
        ($shareBox || {}).style.display = 'inline-flex';
        const enc = encodeURIComponent(url);
        if ($waBtn) $waBtn.href = `https://wa.me/?text=${enc}`;
        if ($tgBtn) $tgBtn.href = `https://t.me/share/url?url=${enc}`;
        const copied = await copyToClipboard(url);
        if (copied) showToast('Скопировано'); else alert('Ссылка сгенерирована:\n' + url);
        if (navigator.share) { try { await navigator.share({ title:'Подбор площадок', url }); } catch {} }
      });
      */
      
      $genBtn?.addEventListener('click', () => {
        if (!selected.size) return;
        // префилл
        $cfgExpire.value = '7';
        $cfgDateWrap.style.display = 'none';
        $cfgSlug.value = '';     // можно автогенерить, оставим вручную
        $cfgNote.value = 'Подбор от ' + new Date().toLocaleString();
        openCfg();
      });

      $cfgCreate?.addEventListener('click', async () => {
        if (!selected.size) return;
      
        // slug — валидируем
        let slug = ($cfgSlug.value || '').trim().toLowerCase();
        if (!slug) slug = Math.random().toString(36).slice(2,8);
        if (!/^[a-z0-9-]{3,50}$/.test(slug)) {
          alert('Slug должен содержать только латиницу, цифры и дефисы (3–50 символов).');
          return;
        }
      
        // срок
        let expiresAt;
        if ($cfgExpire.value === 'custom') {
          if (!$cfgDate.value) { alert('Укажите дату/время истечения.'); return; }
          expiresAt = new Date($cfgDate.value);
        } else {
          const days = parseInt($cfgExpire.value, 10) || 7;
          expiresAt = new Date(Date.now() + days*24*60*60*1000);
        }
      
        const ids   = Array.from(selected);
        const token = Math.random().toString(36).slice(2,10);
        const note  = $cfgNote.value?.trim() || null;
      
        try {
          // создаём документ (если slug занят — просто перезапишем)
          await setDoc(doc(db, COL.shortlists, slug), {
            venue_ids: ids,
            token_hash: await sha256Hex(token),
            note,
            created_at: serverTimestamp(),
            expires_at: expiresAt
          });
      
          closeCfg();
      
          // готовим ссылку + шаринг
          const url = `${location.origin}/?shortlist=${slug}&token=${token}`;
          lastGeneratedUrl = url;
          ($shareBox || {}).style.display = 'inline-flex';
          const enc = encodeURIComponent(url);
          if ($waBtn) $waBtn.href = `https://wa.me/?text=${enc}`;
          if ($tgBtn) $tgBtn.href = `https://t.me/share/url?url=${enc}`;
      
          const copied = await copyToClipboard(url);
          if (copied) showToast('Скопировано'); else alert('Ссылка:\n' + url);
          if (navigator.share) { try { await navigator.share({ title:'Подбор площадок', url }); } catch {} }
        } catch (e) {
          console.error(e);
          alert('Не удалось создать ссылку: ' + (e?.message || e));
        }
      });

      // Старт — решаем, что грузить
      const qs = new URLSearchParams(location.search);
      const shortlistSlug  = qs.get('shortlist');
      const shortlistToken = qs.get('token');
      try {
        if (shortlistSlug && shortlistToken) await loadShortlist(shortlistSlug, shortlistToken);
        else await loadAllVenues();
      } catch (e) {
        console.error(e);
        $status.textContent = 'Ошибка загрузки: ' + (e?.message || e);
      }
    });

    function debounce(fn, ms=200){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }
  </script>
</body>
</html>
