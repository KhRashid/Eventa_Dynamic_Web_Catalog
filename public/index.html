<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–∞—Ä—Ç–æ—Ç–µ–∫–∞ –ø–ª–æ—â–∞–¥–æ–∫</title>

  <!-- firebaseConfig -->
  <script>
    window.__FIREBASE_CONFIG__ = {
      apiKey: "AIzaSyANblr6MInsVbY9LnN3OUHNA5Ri2ttPHCo",
      authDomain: "ai-event-bot.firebaseapp.com",
      databaseURL: "https://ai-event-bot-default-rtdb.firebaseio.com",
      projectId: "ai-event-bot",
      storageBucket: "ai-event-bot.firebasestorage.app",
      messagingSenderId: "884896771261",
      appId: "1:884896771261:web:b60d950938a924a71a5bd4",
      measurementId: "G-4H9BVWN184"
    };
    window.__FIREBASE_COLLECTIONS__ = { 
      venues: "venues", 
      shortlists: "shortlists",
      singers: "singers",
      singer_shortlists: "singer_shortlists"
    };
  </script>

  <!-- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –°–¢–†–ê–ù–ò–¶–´ -->
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --txt:#0f172a; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 4px;font-size:28px}
    .sub{color:var(--muted);margin:0 0 16px}
    .status{margin:8px 0 16px;font-size:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 1px 3px rgb(0 0 0 / 0.05)}
    .img{height:180px;background:#eee;display:block;width:100%;object-fit:cover}
    .body{padding:14px}
    .row{display:flex;justify-content:space-between;gap:12px}
    .loc{color:var(--muted);font-size:14px}
    .p{margin:8px 0 0;color:#334155;font-size:14px;line-height:1.35}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--border);background:white;border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#fafafa}
    .footer{margin:24px 0 12px;color:var(--muted);font-size:12px;text-align:center}
    .note{font-size:12px;color:var(--muted)}
    .inp{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .catalog-tab{border:none;background:transparent;padding:12px 20px;font-size:15px;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s}
    .catalog-tab:hover{background:#f1f5f9}
    .catalog-tab.active{border-bottom-color:#2563eb;color:#2563eb;font-weight:600}
    @media (max-width:900px){ #filters{grid-template-columns:1fr 1fr; } }
    a.btn, a.btn:link, a.btn:visited, a.btn:hover, a.btn:active {
      text-decoration: none !important;
    }
  </style>

  <!-- –°–¢–ò–õ–ò –ú–û–î–ê–õ–ö–ò –ì–ê–õ–ï–†–ï–ò -->
  <style>
    .gallery-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:50}
    .gallery-backdrop.show{display:flex}
    .gallery-wrap{max-width:min(1200px,96vw);max-height:90vh;display:flex;flex-direction:column;gap:10px}
    .gallery-stage{position:relative;background:#000;border-radius:12px;overflow:hidden}
    .gallery-img{max-width:96vw;max-height:70vh;display:block;margin:0 auto}
    .gallery-close,.gallery-prev,.gallery-next{
      position:absolute;top:10px;border:none;background:rgba(255,255,255,.15);color:#fff;
      width:40px;height:40px;border-radius:999px;cursor:pointer;font-size:18px;backdrop-filter:blur(2px)
    }
    .gallery-close{right:10px}
    .gallery-prev{left:10px;top:50%;transform:translateY(-50%)}
    .gallery-next{right:10px;top:50%;transform:translateY(-50%)}
    .gallery-strip{display:flex;gap:8px;overflow-x:auto;padding:6px;background:#0b0b0b;border-radius:12px}
    .gallery-thumb{width:80px;height:60px;object-fit:cover;border-radius:8px;opacity:.6;border:2px solid transparent;cursor:pointer}
    .gallery-thumb.active{opacity:1;border-color:#fff}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:55;overflow-y:auto}
    .modal-backdrop.show{display:flex}
    .modal-content{background:#fff;border-radius:16px;max-width:min(700px,92vw);max-height:85vh;overflow-y:auto;padding:20px;position:relative}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:12px}
    .modal-title{font-size:20px;font-weight:700}
    .modal-close{border:none;background:#f1f5f9;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:18px}
    .modal-close:hover{background:#e2e8f0}
    .modal-body{font-size:14px;line-height:1.6}

    .select-dot{
      position:absolute;top:10px;left:10px;width:22px;height:22px;border-radius:999px;
      border:2px solid #fff;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:14px;cursor:pointer;user-select:none
    }
    .card.sel{outline:2px solid #2563eb}
    .card-wrap{position:relative}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="pageTitle">–ö–∞—Ä—Ç–æ—Ç–µ–∫–∞ –ø–ª–æ—â–∞–¥–æ–∫</h1>
    
    <!-- –¢–∞–±—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤ -->
    <div id="catalogTabs" style="display:flex;gap:8px;margin:12px 0 16px;border-bottom:2px solid var(--border);padding-bottom:0">
      <button class="catalog-tab active" data-catalog="venues">–ü–ª–æ—â–∞–¥–∫–∏</button>
      <button class="catalog-tab" data-catalog="singers">–ü–µ–≤—Ü—ã</button>
    </div>

      <div id="toolbar" style="display:flex;gap:10px;align-items:center;margin:10px 0 16px;flex-wrap:wrap">
        <label style="display:flex;gap:8px;align-items:center;">
          <input id="modeToggle" type="checkbox">
          <span>–†–µ–∂–∏–º –ø–æ–¥–±–æ—Ä–∞</span>
        </label>
      
        <button id="genBtn" type="button" class="btn" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      
        <!-- –ë–ª–æ–∫ —à–∞—Ä–∏–Ω–≥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
        <span id="shareBox" style="display:none;gap:8px;align-items:center;">
          <button id="copyBtn" type="button" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <a id="waBtn" class="btn" target="_blank" rel="noreferrer">WhatsApp</a>
          <a id="tgBtn" class="btn" target="_blank" rel="noreferrer">Telegram</a>
        </span>
      
        <span id="selCount" style="color:#6b7280;font-size:14px">–í—ã–±—Ä–∞–Ω–æ: 0</span>
      </div>

    <div id="filters" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;margin:8px 0 16px">
      <input id="fSearch" type="text" placeholder="–ü–æ–∏—Å–∫: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ä–∞–π–æ–Ω, —Ç–µ–≥–∏‚Ä¶" class="inp">
      <select id="fDistrict" class="inp"><option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option></select>
      <input id="fCap" type="text" placeholder="–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: 100-300" class="inp">
      <input id="fPrice" type="text" placeholder="–¶–µ–Ω–∞/–≥–æ—Å—Ç—å: 20-100" class="inp">
    </div>

    <p class="sub">–°–ø–∏—Å–æ–∫ –ø–ª–æ—â–∞–¥–æ–∫ —Å Firebase. –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç <code>?shortlist=SLUG&token=TOKEN</code>.</p>
    <div id="status" class="status"></div>
    <div id="grid" class="grid"></div>
    <div id="empty" style="display:none;color:#9ca3af;text-align:center;padding:40px 0">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
    <div class="footer">Demo: –¥–∞–Ω–Ω—ã–µ –∏–∑ Firestore. –ú–µ–¥–∏–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ URL.</div>
  </div>
  
  <!-- Gallery modal -->
  <div id="gallery" class="gallery-backdrop" aria-hidden="true">
    <div class="gallery-wrap">
      <div class="gallery-stage">
        <img id="gallery-img" class="gallery-img" alt="">
        <button id="gallery-close" class="gallery-close" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <button id="gallery-prev"  class="gallery-prev"  title="–ù–∞–∑–∞–¥">‚ùÆ</button>
        <button id="gallery-next"  class="gallery-next  title="–í–ø–µ—Ä—ë–¥">‚ùØ</button>
      </div>
      <div id="gallery-strip" class="gallery-strip"></div>
    </div>
  </div>

  <div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
  background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:60">
    –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ
  </div>

  <!-- Repertoire Modal -->
  <div id="repertoireModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">–†–µ–ø–µ—Ä—Ç—É–∞—Ä</div>
        <button class="modal-close" onclick="closeRepertoireModal()">‚úï</button>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:12px">
        <input id="repSearch" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." class="inp" style="flex:1">
        <select id="repLangFilter" class="inp" style="width:140px">
          <option value="">–í—Å–µ —è–∑—ã–∫–∏</option>
        </select>
      </div>
      <div id="repertoireBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Packages Modal -->
  <div id="packagesModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">–ü–∞–∫–µ—Ç—ã –∏ —Ç–∞—Ä–∏—Ñ—ã</div>
        <button class="modal-close" onclick="closePackagesModal()">‚úï</button>
      </div>
      <div id="packagesBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Contacts Modal -->
  <div id="contactsModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
        <button class="modal-close" onclick="closeContactsModal()">‚úï</button>
      </div>
      <div id="contactsBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Link Config Modal -->
  <div id="linkConfig" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:70">
    <div style="background:#fff;border-radius:16px;max-width:520px;width:92vw;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:700;font-size:18px">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Å—ã–ª–∫–∏</div>
        <button id="cfgClose" type="button" style="border:none;background:#f1f5f9;border-radius:10px;padding:6px 10px;cursor:pointer">‚úï</button>
      </div>
  
      <div style="display:grid;gap:12px">
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</span>
          <select id="cfgExpire" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px">
            <option value="7">7 –¥–Ω–µ–π</option>
            <option value="14">14 –¥–Ω–µ–π</option>
            <option value="30">30 –¥–Ω–µ–π</option>
            <option value="custom">–£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É</option>
          </select>
        </label>
  
        <label id="cfgDateWrap" style="display:none;gap:6px">
          <span style="font-size:14px;color:#475569;margin-right:8px">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (–ª–æ–∫–∞–ª—å–Ω—ã–µ)</span>
          <input id="cfgDate" type="datetime-local" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
        </label>
  
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (slug, –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/–¥–µ—Ñ–∏—Å—ã)</span>
          <input id="cfgSlug" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, ivanov-1016"
                 style="padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
        </label>
  
        <label style="display:grid;gap:6px">
          <span style="font-size:14px;color:#475569">–ó–∞–º–µ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
          <textarea id="cfgNote" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥ –≤–∞—à—É –¥–∞—Ç—É –µ—Å—Ç—å —Å–ø–µ—Ü—É—Å–ª–æ–≤–∏—è"
                    style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;resize:vertical"></textarea>
        </label>
      </div>
  
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
        <button id="cfgCancel" type="button" class="btn">–û—Ç–º–µ–Ω–∞</button>
        <button id="cfgCreate" type="button" class="btn">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, collection, getDocs, getDoc, doc,
    setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  // === CONFIG ===
  const CFG = window.__FIREBASE_CONFIG__;
  const COL = (window.__FIREBASE_COLLECTIONS__ || { venues:"venues", shortlists:"shortlists", singers:"singers", singer_shortlists:"singer_shortlists" });

  // === CATALOG CONFIGURATION ===
  const CATALOG_CONFIG = {
    venues: {
      collection: 'venues',
      shortlistCollection: 'shortlists',
      title: '–ö–∞—Ä—Ç–æ—Ç–µ–∫–∞ –ø–ª–æ—â–∞–¥–æ–∫',
      filterLayout: '2fr 1fr 1fr 1fr',
      filters: {
        search: { id: 'fSearch', placeholder: '–ü–æ–∏—Å–∫: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ä–∞–π–æ–Ω, —Ç–µ–≥–∏‚Ä¶', type: 'text' },
        district: { id: 'fDistrict', placeholder: '–í—Å–µ —Ä–∞–π–æ–Ω—ã', type: 'select' },
        capacity: { id: 'fCap', placeholder: '–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: 100-300', type: 'text' },
        price: { id: 'fPrice', placeholder: '–¶–µ–Ω–∞/–≥–æ—Å—Ç—å: 20-100', type: 'text' }
      }
    },
    singers: {
      collection: 'singers',
      shortlistCollection: 'singer_shortlists',
      title: '–ö–∞—Ç–∞–ª–æ–≥ –ø–µ–≤—Ü–æ–≤',
      filterLayout: '2fr 1fr 1fr 1fr 1fr 1fr',
      filters: {
        search: { id: 'fSearch', placeholder: '–ü–æ–∏—Å–∫: –∏–º—è, –ø—Å–µ–≤–¥–æ–Ω–∏–º, —Ç–µ–≥–∏‚Ä¶', type: 'text' },
        price: { id: 'fPrice', placeholder: '–¶–µ–Ω–∞ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è: 500-2000', type: 'text' },
        gender: { id: 'fGender', placeholder: '–í—Å–µ', type: 'select', options: ['–í—Å–µ', 'female', 'male', 'group', 'duo'] },
        genres: { id: 'fGenres', placeholder: '–ñ–∞–Ω—Ä—ã', type: 'select' },
        languages: { id: 'fLanguages', placeholder: '–Ø–∑—ã–∫–∏', type: 'select' },
        city: { id: 'fCity', placeholder: '–í—Å–µ –≥–æ—Ä–æ–¥–∞', type: 'select' }
      }
    }
  };

  let activeCatalog = 'venues';  // —Ç–µ–∫—É—â–∏–π –∫–∞—Ç–∞–ª–æ–≥

  // === refs –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ–±—ä—è–≤–ª—è–µ–º –∑–∞—Ä–∞–Ω–µ–µ!)
  let $fSearch, $fDistrict, $fCap, $fPrice, $fGender, $fGenres, $fLanguages, $fCity;

  // === GLOBALS ===
  let db, auth;
  let pickMode = false;
  const selected = new Set();
  let lastGeneratedUrl = "";
  let touchStartX = null;

  let filtersBound = false;           // –¥–ª—è –µ–¥–∏–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª–µ–π

  // —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–ª—è ¬´–º—è–≥–∫–æ–π¬ª –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
  window.__lastVenues = [];
  window.__lastMeta   = null;

  // —É—Ç–∏–ª–∏—Ç—ã
  const fmt = (n) => new Intl.NumberFormat('ru-RU').format(n);
  
  // –ü–∞—Ä—Å–∏–º —á–∏—Å–ª–æ
  const toNum = (x) => {
    if (x == null) return NaN;
    if (typeof x === 'number') return x;
    if (typeof x === 'string') {
      const m = x.replace(',', '.').match(/-?\d+(\.\d+)?/);
      return m ? parseFloat(m[0]) : NaN;
    }
    return NaN;
  };
  
  // –î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω –∏–∑ –º–µ–Ω—é (price_azn)
  function getPriceRangeFromMenu(menu) {
    if (!menu || !Array.isArray(menu)) return { min: NaN, max: NaN };
    const prices = [];
    for (const cat of menu) {
      const items = Array.isArray(cat?.items) ? cat.items : [];
      for (const it of items) {
        const p = toNum(it?.price_azn ?? it?.priceAZN ?? it?.price);
        if (!Number.isNaN(p)) prices.push(p);
      }
    }
    if (!prices.length) return { min: NaN, max: NaN };
    return { min: Math.min(...prices), max: Math.max(...prices) };
  }
  
  // –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Ü–µ–Ω—ã –ø–ª–æ—â–∞–¥–∫–∏
  function getVenuePriceMinMax(v) {
    // —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º ¬´–ø—Ä—è–º—ã–µ¬ª –ø–æ–ª—è (–µ—Å–ª–∏ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –ø–æ—è–≤—è—Ç—Å—è)
    let pMin = toNum(v.price_min ?? v.priceMin ?? v.min_price ?? v.pricing_min ?? v.price?.min);
    let pMax = toNum(v.price_max ?? v.priceMax ?? v.max_price ?? v.pricing_max ?? v.price?.max);
    // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å—á–∏—Ç–∞–µ–º –∏–∑ –º–µ–Ω—é
    if (Number.isNaN(pMin) && Number.isNaN(pMax)) {
      const viaMenu = getPriceRangeFromMenu(v.menu);
      pMin = viaMenu.min; pMax = viaMenu.max;
    }
    return { min: pMin, max: pMax };
  }
  
  // –î–∏–∞–ø–∞–∑–æ–Ω –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–ª–æ—â–∞–¥–∫–∏
  function getVenueCapacityMinMax(v) {
    const cMin = toNum(v.capacity_min ?? v.capacityMin ?? v.min_capacity ?? v.capacity?.min);
    const cMax = toNum(v.capacity_max ?? v.capacityMax ?? v.max_capacity ?? v.capacity?.max);
    return { min: cMin, max: cMax };
  }
  
  // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
  // –û–¥–∏–Ω–æ–∫–æ–µ —á–∏—Å–ª–æ = "–Ω—É–∂–Ω–æ —É–º–µ—Å—Ç–∏—Ç—å N –≥–æ—Å—Ç–µ–π": —Ç—Ä–µ–±—É–µ—Ç—Å—è cMin <= N <= cMax
  function capacityMatches(cMin, cMax, capLo, capHi) {
    if (Number.isNaN(cMin) || Number.isNaN(cMax)) return false;
    if (capLo == null && capHi == null) return true;
    if (capHi == null && capLo != null) {          // –æ–¥–∏–Ω–æ—á–Ω–æ–µ —á–∏—Å–ª–æ
      return cMin <= capLo && cMax >= capLo;
    }
    // –¥–∏–∞–ø–∞–∑–æ–Ω ‚Üí –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
    if (capLo != null && cMax < capLo) return false;
    if (capHi != null && cMin > capHi) return false;
    return true;
  }
  
  // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Ü–µ–Ω—ã –ø–æ —Ñ–∏–ª—å—Ç—Ä—É (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  function priceMatches(pMin, pMax, priceLo, priceHi) {
    if (Number.isNaN(pMin) || Number.isNaN(pMax)) return false;
    if (priceLo == null && priceHi == null) return true;
    if (priceHi == null && priceLo != null) {      // –æ–¥–∏–Ω–æ—á–Ω–æ–µ —á–∏—Å–ª–æ
      return pMin <= priceLo && pMax >= priceLo;
    }
    // –¥–∏–∞–ø–∞–∑–æ–Ω ‚Üí –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
    if (priceLo != null && pMax < priceLo) return false;
    if (priceHi != null && pMin > priceHi) return false;
    return true;
  }
  
  const sha256Hex = async (text) => {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
  };

  // === SINGER-SPECIFIC HELPERS ===
  function getSingerPrice(singer) {
    if (!Array.isArray(singer.pricing_packages) || !singer.pricing_packages.length) {
      return { min: NaN, max: NaN };
    }
    const active = singer.pricing_packages.filter(p => p.is_active !== false);
    const prices = active.map(p => toNum(p.price)).filter(p => !Number.isNaN(p));
    if (!prices.length) return { min: NaN, max: NaN };
    return { min: Math.min(...prices), max: Math.max(...prices) };
  }

  function getGenderLabel(gender) {
    const labels = { female: '–ñ–µ–Ω—Å–∫–∏–π', male: '–ú—É–∂—Å–∫–æ–π', group: '–ì—Ä—É–ø–ø–∞', duo: '–î—É—ç—Ç' };
    return labels[gender] || gender;
  }

  function debounce(fn, ms=200){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
  }

  function normalizeMedia(m) {
    if (!m) return [];
    if (Array.isArray(m)) {
      return m.flatMap(x => {
        if (typeof x === 'string') return [{ type:'image', url:x }];
        if (x && typeof x === 'object') {
          const url = x.url || x.src || x.image || x.link;
          return url ? [{ type: x.type || 'image', url }] : [];
        }
        return [];
      });
    }
    if (typeof m === 'string') return [{ type:'image', url:m }];
    if (typeof m === 'object') {
      const out = [];
      const pushArr = (arr, typeGuess='image') => {
        if (!Array.isArray(arr)) return;
        arr.forEach(v => {
          if (typeof v === 'string') out.push({ type:typeGuess, url:v });
          else if (v && typeof v === 'object') {
            const url = v.url || v.src || v.image || v.link;
            if (url) out.push({ type: v.type || typeGuess, url });
          }
        });
      };
      pushArr(m.photos || m.images || m.pictures, 'image');
      pushArr(m.videos || m.video, 'video');
      if (!out.length) {
        const url = m.url || m.src || m.image || m.link;
        if (url) out.push({ type:m.type || 'image', url });
      }
      return out;
    }
    return [];
  }

  function getDistrictValue(){
    if (!$fDistrict) return '';
    const v = ($fDistrict.value || '').trim();
    const low = v.toLowerCase();
    // –ª—é–±—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã ¬´–≤—Å–µ —Ä–∞–π–æ–Ω—ã¬ª —Å—á–∏—Ç–∞–µ–º –ø—É—Å—Ç—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
    if (v === '' || low === '–≤—Å–µ —Ä–∞–π–æ–Ω—ã' || low === 'all' ) return '';
    return [];
  }

  // === MODAL HELPERS ===
  let currentRepertoire = [];
  let currentSinger = null;

  function openRepertoireModal(singer) {
    if (!singer || !Array.isArray(singer.repertoire)) return;
    currentSinger = singer;
    currentRepertoire = singer.repertoire.slice();
    
    const $modal = document.getElementById('repertoireModal');
    const $body = document.getElementById('repertoireBody');
    const $search = document.getElementById('repSearch');
    const $langFilter = document.getElementById('repLangFilter');
    
    // Populate language filter
    const langs = Array.from(new Set(currentRepertoire.map(s => s.language).filter(Boolean))).sort();
    $langFilter.innerHTML = '<option value="">–í—Å–µ —è–∑—ã–∫–∏</option>' + 
      langs.map(l => `<option value="${l}">${l.toUpperCase()}</option>`).join('');
    
    $search.value = '';
    $langFilter.value = '';
    
    renderRepertoire();
    $modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeRepertoireModal() {
    const $modal = document.getElementById('repertoireModal');
    $modal.classList.remove('show');
    document.body.style.overflow = '';
    currentRepertoire = [];
    currentSinger = null;
  }

  function renderRepertoire() {
    const $body = document.getElementById('repertoireBody');
    const $search = document.getElementById('repSearch');
    const $langFilter = document.getElementById('repLangFilter');
    
    const q = ($search?.value || '').trim().toLowerCase();
    const lang = $langFilter?.value || '';
    
    let filtered = currentRepertoire.filter(song => {
      if (lang && song.language !== lang) return false;
      if (q && !(song.title || '').toLowerCase().includes(q) && !(song.original_artist || '').toLowerCase().includes(q)) return false;
      return true;
    });
    
    if (!filtered.length) {
      $body.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:20px">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
      return;
    }
    
    // Group by language
    const byLang = {};
    filtered.forEach(s => {
      const l = s.language || 'other';
      if (!byLang[l]) byLang[l] = [];
      byLang[l].push(s);
    });
    
    let html = '';
    Object.keys(byLang).sort().forEach(lang => {
      html += `<div style="margin-bottom:16px">
        <div style="font-weight:600;font-size:15px;margin-bottom:8px;color:#475569">
          ${lang.toUpperCase()} (${byLang[lang].length})
        </div>
        <ul style="list-style:none;padding:0;margin:0">`;
      byLang[lang].forEach(s => {
        const dur = s.duration_sec ? ` ‚Ä¢ ${Math.floor(s.duration_sec/60)}:${String(s.duration_sec%60).padStart(2,'0')}` : '';
        html += `<li style="padding:6px 0;border-bottom:1px solid #f1f5f9">
          <div style="font-weight:500">${s.title || ''}</div>
          <div style="font-size:13px;color:#64748b">${s.original_artist || ''}${dur}</div>
        </li>`;
      });
      html += '</ul></div>';
    });
    
    $body.innerHTML = html;
  }

  function openPackagesModal(singer) {
    if (!singer || !Array.isArray(singer.pricing_packages)) return;
    const $modal = document.getElementById('packagesModal');
    const $body = document.getElementById('packagesBody');
    
    const active = singer.pricing_packages.filter(p => p.is_active !== false);
    if (!active.length) {
      $body.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:20px">–ü–∞–∫–µ—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>';
    } else {
      let html = '<div style="display:grid;gap:16px">';
      active.forEach(pkg => {
        html += `<div style="border:1px solid var(--border);border-radius:12px;padding:16px">
          <div style="font-weight:600;font-size:16px;margin-bottom:4px">${pkg.title || ''}</div>
          <div style="font-size:20px;font-weight:700;color:#2563eb;margin-bottom:8px">
            ${fmt(pkg.price)} ${pkg.currency || 'AZN'}
          </div>
          ${pkg.duration_min ? `<div style="font-size:14px;color:#64748b;margin-bottom:8px">‚è± ${pkg.duration_min} –º–∏–Ω—É—Ç</div>` : ''}
          ${pkg.description ? `<div style="font-size:14px;color:#475569">${pkg.description}</div>` : ''}
        </div>`;
      });
      html += '</div>';
      $body.innerHTML = html;
    }
    
    $modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closePackagesModal() {
    const $modal = document.getElementById('packagesModal');
    $modal.classList.remove('show');
    document.body.style.overflow = '';
  }

  function openContactsModal(singer) {
    if (!singer) return;
    const $modal = document.getElementById('contactsModal');
    const $body = document.getElementById('contactsBody');
    
    let html = '<div style="display:grid;gap:12px">';
    
    if (Array.isArray(singer.phones) && singer.phones.length) {
      html += '<div><div style="font-weight:600;margin-bottom:6px">üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã:</div><ul style="list-style:none;padding:0;margin:0">';
      singer.phones.forEach(ph => {
        html += `<li style="padding:4px 0"><a href="tel:${ph}" style="color:#2563eb">${ph}</a></li>`;
      });
      html += '</ul></div>';
    }
    
    if (singer.contact_public && typeof singer.contact_public === 'object') {
      html += '<div><div style="font-weight:600;margin-bottom:6px">üåê –°–æ—Ü—Å–µ—Ç–∏:</div><ul style="list-style:none;padding:0;margin:0">';
      Object.entries(singer.contact_public).forEach(([key, val]) => {
        if (val) {
          html += `<li style="padding:4px 0"><a href="${val}" target="_blank" rel="noopener noreferrer" style="color:#2563eb">${key}: ${val}</a></li>`;
        }
      });
      html += '</ul></div>';
    }
    
    html += '</div>';
    $body.innerHTML = html;
    
    $modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeContactsModal() {
    const $modal = document.getElementById('contactsModal');
    $modal.classList.remove('show');
    document.body.style.overflow = '';
  }

  // Bind modal events
  window.closeRepertoireModal = closeRepertoireModal;
  window.closePackagesModal = closePackagesModal;
  window.closeContactsModal = closeContactsModal;

  // –∂–¥—ë–º DOM ‚Äî —Ç—É—Ç –º—ã –±–µ—Ä—ë–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –≤–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  window.addEventListener('DOMContentLoaded', async () => {
    // Firebase
    const app = initializeApp(CFG);
    db   = getFirestore(app);
    auth = getAuth(app);
    signInAnonymously(auth).catch(console.error);

    // DOM refs
    const $status    = document.getElementById('status') || {textContent:''};
    const $grid      = document.getElementById('grid');
    const $empty     = document.getElementById('empty');
    const $modeToggle= document.getElementById('modeToggle');
    const $genBtn    = document.getElementById('genBtn');
    const $selCount  = document.getElementById('selCount');
    const $shareBox  = document.getElementById('shareBox');
    const $copyBtn   = document.getElementById('copyBtn');
    const $waBtn     = document.getElementById('waBtn');
    const $tgBtn     = document.getElementById('tgBtn');
    const $toast     = document.getElementById('toast');
    const $pageTitle = document.getElementById('pageTitle');
    const $filtersContainer = document.getElementById('filters');

    // –∫–∞—Ç–∞–ª–æ–≥ —Ç–∞–±—ã
    const $catalogTabs = document.getElementById('catalogTabs');
    
    // —Ñ–∏–ª—å—Ç—Ä—ã (–±—É–¥—É—Ç –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–∞–ª–æ–≥–∞)
    $fSearch   = document.getElementById('fSearch');
    $fDistrict = document.getElementById('fDistrict');
    $fCap      = document.getElementById('fCap');
    $fPrice    = document.getElementById('fPrice');
    $fGender   = document.getElementById('fGender');
    $fGenres   = document.getElementById('fGenres');
    $fLanguages= document.getElementById('fLanguages');
    $fCity     = document.getElementById('fCity');

    // –ì–∞–ª–µ—Ä–µ—è (—ç–ª–µ–º–µ–Ω—Ç—ã —É–∂–µ –µ—Å—Ç—å –≤–Ω–∏–∑—É body)
    const $g      = document.getElementById('gallery');
    const $gImg   = document.getElementById('gallery-img');
    const $gStrip = document.getElementById('gallery-strip');
    const $gPrev  = document.getElementById('gallery-prev');
    const $gNext  = document.getElementById('gallery-next');
    const $gClose = document.getElementById('gallery-close');
    let galleryUrls = [];
    let galleryIndex = 0;

    // –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    let _allVenues = [];   // –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ (–∏–ª–∏ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ —à–æ—Ä—Ç–ª–∏—Å—Ç–∞)
    let _viewVenues = [];  // –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

    // ---- link-config modal
    const $cfg     = document.getElementById('linkConfig');
    const $cfgClose= document.getElementById('cfgClose');
    const $cfgCancel= document.getElementById('cfgCancel');
    const $cfgCreate= document.getElementById('cfgCreate');
    const $cfgExpire= document.getElementById('cfgExpire');
    const $cfgDateWrap= document.getElementById('cfgDateWrap');
    const $cfgDate = document.getElementById('cfgDate');
    const $cfgSlug = document.getElementById('cfgSlug');
    const $cfgNote = document.getElementById('cfgNote');

    function openCfg() { $cfg.style.display='flex'; }
    function closeCfg(){ $cfg.style.display='none'; }
    $cfgClose?.addEventListener('click', closeCfg);
    $cfgCancel?.addEventListener('click', closeCfg);
    $cfg?.addEventListener('click', (e)=>{ if(e.target===$cfg) closeCfg(); });
    $cfgExpire?.addEventListener('change', ()=>{
      $cfgDateWrap.style.display = ($cfgExpire.value === 'custom') ? 'grid' : 'none';
    });

    // ---- Gallery helpers
    function renderGallery(){
      $gImg.src = galleryUrls[galleryIndex];
      $gStrip.innerHTML = '';
      galleryUrls.forEach((u,i)=>{
        const img = document.createElement('img');
        img.className = 'gallery-thumb' + (i===galleryIndex ? ' active' : '');
        img.src = u;
        img.addEventListener('click', ()=>{ galleryIndex=i; renderGallery(); });
        $gStrip.appendChild(img);
      });
    }
    function openGallery(urls, startIdx=0){
      galleryUrls = urls.filter(Boolean);
      if (!galleryUrls.length) return;
      galleryIndex = Math.min(Math.max(0, startIdx), galleryUrls.length-1);
      renderGallery();
      $g.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeGallery(){
      $g.classList.remove('show');
      document.body.style.overflow = '';
    }
    $gNext?.addEventListener('click', ()=>{ galleryIndex=(galleryIndex+1)%galleryUrls.length; renderGallery(); });
    $gPrev?.addEventListener('click', ()=>{ galleryIndex=(galleryIndex-1+galleryUrls.length)%galleryUrls.length; renderGallery(); });
    $gClose?.addEventListener('click', closeGallery);
    $g?.addEventListener('click', (e)=>{ if(e.target===$g) closeGallery(); });
    window.addEventListener('keydown', (e)=>{
      if(!$g.classList.contains('show')) return;
      if(e.key==='Escape') closeGallery();
      if(e.key==='ArrowRight') $gNext.click();
      if(e.key==='ArrowLeft')  $gPrev.click();
    });
    $g?.addEventListener('touchstart', (e)=>{ touchStartX = e.changedTouches[0].clientX; }, {passive:true});
    $g?.addEventListener('touchend', (e)=>{
      if(touchStartX==null) return;
      const dx = e.changedTouches[0].clientX - touchStartX;
      if(Math.abs(dx) > 40) { dx<0 ? $gNext.click() : $gPrev.click(); }
      touchStartX = null;
    }, {passive:true});

    // ---- —Ä–µ–ø–µ—Ä—Ç—É–∞—Ä —Ñ–∏–ª—å—Ç—Ä—ã
    document.getElementById('repSearch')?.addEventListener('input', debounce(renderRepertoire, 200));
    document.getElementById('repLangFilter')?.addEventListener('change', renderRepertoire);

    // ---- Catalog Tabs
    function switchCatalog(catalog) {
      if (!CATALOG_CONFIG[catalog]) return;
      activeCatalog = catalog;
      
      // Update tab styles
      document.querySelectorAll('.catalog-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.catalog === catalog);
      });
      
      // Update title
      $pageTitle.textContent = CATALOG_CONFIG[catalog].title;
      
      // Reset selection mode
      pickMode = false;
      $modeToggle.checked = false;
      selected.clear();
      $selCount.textContent = '–í—ã–±—Ä–∞–Ω–æ: 0';
      $genBtn.disabled = true;
      $shareBox.style.display = 'none';
      lastGeneratedUrl = '';
      
      // Rebuild filters
      buildFilters(catalog);
      
      // Update URL
      const params = new URLSearchParams(location.search);
      params.set('catalog', catalog);
      history.replaceState(null, '', `${location.pathname}?${params.toString()}`);
      
      // Reload data
      loadCatalogData(catalog);
    }
    
    $catalogTabs?.querySelectorAll('.catalog-tab').forEach(tab => {
      tab.addEventListener('click', () => switchCatalog(tab.dataset.catalog));
    });

    // ---- —Ç–æ—Å—Ç + –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
    function showToast(text='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ') {
      if (!$toast) return;
      $toast.textContent = text;
      $toast.style.opacity = '1';
      setTimeout(()=> $toast.style.opacity = '0', 1400);
    }
    async function copyToClipboard(text) {
      try { await navigator.clipboard.writeText(text); return true; } catch{}
      try {
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.select();
        const ok = document.execCommand('copy'); document.body.removeChild(ta);
        return ok;
      } catch { return false; }
    }
    document.getElementById('copyBtn')?.addEventListener('click', async () => {
      if (!lastGeneratedUrl) { alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É.'); return; }
      const ok = await copyToClipboard(lastGeneratedUrl);
      showToast(ok ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é');
    });

    // ---- —Ä–µ–∂–∏–º –ø–æ–¥–±–æ—Ä–∞
    function rerender(){ render(window.__lastVenues, window.__lastMeta); }
    $modeToggle?.addEventListener('change', ()=>{
      pickMode = $modeToggle.checked;
      selected.clear();
      $selCount.textContent = '–í—ã–±—Ä–∞–Ω–æ: 0';
      $genBtn.disabled = true;
      $shareBox.style.display = 'none';
      lastGeneratedUrl = '';
      rerender();
    });

    // ---- —Ñ–∏–ª—å—Ç—Ä—ã
    function buildFilters(catalog) {
      const config = CATALOG_CONFIG[catalog];
      if (!config || !$filtersContainer) return;
      
      // Update grid layout
      $filtersContainer.style.gridTemplateColumns = config.filterLayout;
      
      // Build filter inputs
      let html = '';
      Object.values(config.filters).forEach(f => {
        if (f.type === 'text') {
          html += `<input id="${f.id}" type="text" placeholder="${f.placeholder}" class="inp">`;
        } else if (f.type === 'select') {
          html += `<select id="${f.id}" class="inp">`;
          if (f.options) {
            html += f.options.map(opt => `<option value="${opt === '–í—Å–µ' ? '' : opt}">${opt}</option>`).join('');
          } else {
            html += `<option value="">${f.placeholder}</option>`;
          }
          html += `</select>`;
        }
      });
      
      $filtersContainer.innerHTML = html;
      
      // Re-bind refs
      $fSearch   = document.getElementById('fSearch');
      $fDistrict = document.getElementById('fDistrict');
      $fCap      = document.getElementById('fCap');
      $fPrice    = document.getElementById('fPrice');
      $fGender   = document.getElementById('fGender');
      $fGenres   = document.getElementById('fGenres');
      $fLanguages= document.getElementById('fLanguages');
      $fCity     = document.getElementById('fCity');
      
      // Re-bind events
      filtersBound = false;
      bindFilterEventsOnce();
    }
    
    function parseRange(text){
      if(!text) return [null,null];
      const m = (text.replace(/\s/g,'').match(/^(\d+)?-?(\d+)?$/) || []);
      return [m[1]?+m[1]:null, m[2]?+m[2]:null];
    }
    function populateDistricts(list){
      if(!$fDistrict) return;
      const districts = Array.from(new Set(list.map(v=>v.district).filter(Boolean))).sort();
      $fDistrict.innerHTML =
        '<option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>' +
        districts.map(d=>`<option value="${d}">${d}</option>`).join('');
    }
    
    function populateCities(list) {
      if (!$fCity) return;
      const cities = Array.from(new Set(list.map(s => s.city).filter(Boolean))).sort();
      $fCity.innerHTML =
        '<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>' +
        cities.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    function populateGenres(list) {
      if (!$fGenres) return;
      const genres = Array.from(new Set(list.flatMap(s => s.genres || []))).sort();
      $fGenres.innerHTML =
        '<option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>' +
        genres.map(g => `<option value="${g}">${g}</option>`).join('');
    }
    
    function populateLanguages(list) {
      if (!$fLanguages) return;
      const langs = Array.from(new Set(list.flatMap(s => s.languages || []))).sort();
      $fLanguages.innerHTML =
        '<option value="">–í—Å–µ —è–∑—ã–∫–∏</option>' +
        langs.map(l => `<option value="${l}">${l.toUpperCase()}</option>`).join('');
    }
    function ensureDistrictValid(){
      if (!$fDistrict) return;
      const val = ($fDistrict.value||'').trim();
      const opts = Array.from($fDistrict.options).map(o=>o.value);
      // –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ value –Ω–µ—Ç —Å—Ä–µ–¥–∏ –æ–ø—Ü–∏–π –∏–ª–∏ —ç—Ç–æ ¬´–í—Å–µ —Ä–∞–π–æ–Ω—ã¬ª ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
      if (!opts.includes(val) || val.toLowerCase()==='–≤—Å–µ —Ä–∞–π–æ–Ω—ã' || val.toLowerCase()==='all') {
        $fDistrict.value = '';       // –≤—ã–±–µ—Ä–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è –æ–ø—Ü–∏—è <option value="">
        $fDistrict.selectedIndex = 0;
      }
    }    
    function restoreFiltersFromURL(){
      if(!$fSearch) return;
      const ps = new URLSearchParams(location.search);
      $fSearch.value  = ps.get('q')    || '';
      $fDistrict.value= ps.get('d')    || '';
      $fCap.value     = ps.get('cap')  || '';
      $fPrice.value   = ps.get('price')|| '';
    }
    function bindFilterEventsOnce(){
      if(filtersBound || !$fSearch) return;
      filtersBound = true;
      $fSearch.addEventListener('input', debounce(applyFilters,200));
      const allFilters = [$fDistrict,$fCap,$fPrice,$fGender,$fGenres,$fLanguages,$fCity].filter(Boolean);
      allFilters.forEach(el=> el.addEventListener('input', applyFilters));
    }
    function applyFilters(){
      if(!$fSearch) return;
    
      const q = ($fSearch.value||'').trim().toLowerCase();
      
      if (activeCatalog === 'venues') {
        const dist = ($fDistrict?.value || '').trim();
        const [capLo, capHi]     = parseRange(($fCap?.value||'').trim());
        const [priceLo, priceHi] = parseRange(($fPrice?.value||'').trim());
      
        _viewVenues = _allVenues.filter(v=>{
          // –ø–æ–∏—Å–∫
          if(q){
            const hay = [v.name,v.city,v.district,(v.tags||[]).join(' '),v.description]
                        .filter(Boolean).join(' ').toLowerCase();
            if(!hay.includes(q)) return false;
          }
      
          // —Ä–∞–π–æ–Ω
          if(dist && v.district !== dist) return false;
      
          // –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
          const {min: cMin, max: cMax} = getVenueCapacityMinMax(v);
          if(!capacityMatches(cMin, cMax, capLo, capHi)) return false;
      
          // —Ü–µ–Ω–∞/–≥–æ—Å—Ç—å
          const {min: pMin, max: pMax} = getVenuePriceMinMax(v);
          if(!priceMatches(pMin, pMax, priceLo, priceHi)) return false;
      
          return true;
        });
        
        // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ URL
        const params = new URLSearchParams(location.search);
        q ? params.set('q', q) : params.delete('q');
        dist ? params.set('d', dist) : params.delete('d');
        $fCap?.value   ? params.set('cap', ($fCap.value||'').trim())     : params.delete('cap');
        $fPrice?.value ? params.set('price', ($fPrice.value||'').trim()) : params.delete('price');
        const newUrl = `${location.pathname}?${params.toString()}`;
        history.replaceState(null,'',newUrl);
        
      } else if (activeCatalog === 'singers') {
        const [priceLo, priceHi] = parseRange(($fPrice?.value||'').trim());
        const gender = ($fGender?.value || '').trim();
        const genre = ($fGenres?.value || '').trim();
        const lang = ($fLanguages?.value || '').trim();
        const city = ($fCity?.value || '').trim();
        
        _viewVenues = _allVenues.filter(s => {
          // –ø–æ–∏—Å–∫
          if (q) {
            const hay = [s.name, (s.aliases||[]).join(' '), (s.tags||[]).join(' '), (s.genres||[]).join(' ')]
              .filter(Boolean).join(' ').toLowerCase();
            if (!hay.includes(q)) return false;
          }
          
          // –ø–æ–ª
          if (gender && s.gender !== gender) return false;
          
          // –∂–∞–Ω—Ä
          if (genre && (!Array.isArray(s.genres) || !s.genres.includes(genre))) return false;
          
          // —è–∑—ã–∫
          if (lang && (!Array.isArray(s.languages) || !s.languages.includes(lang))) return false;
          
          // –≥–æ—Ä–æ–¥
          if (city && s.city !== city) return false;
          
          // —Ü–µ–Ω–∞
          const {min: pMin, max: pMax} = getSingerPrice(s);
          if (!priceMatches(pMin, pMax, priceLo, priceHi)) return false;
          
          return true;
        });
        
        // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ URL
        const params = new URLSearchParams(location.search);
        q ? params.set('q', q) : params.delete('q');
        $fPrice?.value ? params.set('price', ($fPrice.value||'').trim()) : params.delete('price');
        gender ? params.set('gender', gender) : params.delete('gender');
        genre ? params.set('genre', genre) : params.delete('genre');
        lang ? params.set('lang', lang) : params.delete('lang');
        city ? params.set('city', city) : params.delete('city');
        const newUrl = `${location.pathname}?${params.toString()}`;
        history.replaceState(null,'',newUrl);
      }
    
      render(_viewVenues, window.__lastMeta);
    }


    // ---- RENDER CARDS HELPERS ===
    function renderVenueCard(v) {
      // –æ–±–ª–æ–∂–∫–∞
      let coverUrl = Array.isArray(v.media?.photos) && v.media.photos.length ? v.media.photos[0] : null;
      const mediaArr = normalizeMedia(v.media);
      if (!coverUrl && mediaArr.length) coverUrl = mediaArr[0]?.url || null;

      // SVG –∏–∫–æ–Ω–∫–∏ (16x16)
      const svgPin = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 22s7-5.33 7-12a7 7 0 10-14 0c0 6.67 7 12 7 12z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.7" fill="none"/>
      </svg>`;
      const svgMoney = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <path d="M7 12h10M12 9v6" stroke="currentColor" stroke-width="1.7" />
      </svg>`;
      const svgUsers = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <circle cx="9" cy="8" r="3" stroke="currentColor" stroke-width="1.7"/>
        <path d="M2 19a7 7 0 0114 0" stroke="currentColor" stroke-width="1.7"/>
        <path d="M17 11a2 2 0 100-4" stroke="currentColor" stroke-width="1.7"/>
        <path d="M20.5 19a5.5 5.5 0 00-5.5-4" stroke="currentColor" stroke-width="1.7"/>
      </svg>`;
      
      const rawPriceMin = v.price_min ?? v.priceMin ?? v.min_price ?? v.pricing_min ?? (v.price && v.price.min);
      const rawPriceMax = v.price_max ?? v.priceMax ?? v.max_price ?? v.pricing_max ?? (v.price && v.price.max);
      
      let pMinNum = toNum(rawPriceMin);
      let pMaxNum = toNum(rawPriceMax);
      
      if (Number.isNaN(pMinNum) && Number.isNaN(pMaxNum)) {
        const fromMenu = getPriceRangeFromMenu(v.menu);
        pMinNum = fromMenu.min;
        pMaxNum = fromMenu.max;
      }
      
      const hasPMin = !Number.isNaN(pMinNum);
      const hasPMax = !Number.isNaN(pMaxNum);
      const hasPriceAny = hasPMin || hasPMax;
      
      const currency = v.currency || 'AZN';
      const priceText = hasPriceAny
      ? (hasPMin && hasPMax ? `${fmt(pMinNum)}‚Äì${fmt(pMaxNum)} ${currency}`
         : hasPMin ? `–æ—Ç ${fmt(pMinNum)} ${currency}`
         : `–¥–æ ${fmt(pMaxNum)} ${currency}`)
      : '';
      
      const cMinNum = Number(v.capacity_min), cMaxNum = Number(v.capacity_max);
      const hasCMin = !Number.isNaN(cMinNum), hasCMax = !Number.isNaN(cMaxNum);
      const hasCapAny = hasCMin || hasCMax;
      const capText = hasCapAny
        ? (hasCMin && hasCMax ? `${fmt(cMinNum)}‚Äì${fmt(cMaxNum)}`
           : hasCMin ? `–æ—Ç ${fmt(cMinNum)}`
           : `–¥–æ ${fmt(cMaxNum)}`)
        : '';
      
      const mapHref = v.location_url || ((v.location_lat!=null && v.location_lng!=null)
        ? `https://maps.google.com/?q=${v.location_lat},${v.location_lng}` : '');
      
      return `
        ${coverUrl ? `<img class="img venue-cover" src="${coverUrl}" alt="${v.name||''}" loading="lazy">` : `<div class="img venue-cover"></div>`}
        <div class="body">
          <div class="row">
            <div>
              <div style="font-weight:600;font-size:18px">${v.name||''}</div>
              <div class="loc" style="display:flex;align-items:center;gap:6px;color:#64748b;">
                <span class="ico" style="display:inline-flex;line-height:0;">${svgPin}</span>
                <span>${[v.city, v.district].filter(Boolean).join(', ')}</span>
              </div>
            </div>
            <div style="text-align:right;font-size:14px;color:#475569">
              ${hasPriceAny ? `<div style="display:flex;gap:6px;justify-content:flex-end;align-items:center;">
                  <span class="ico" style="display:inline-flex;line-height:0;">${svgMoney}</span>
                  <span>${priceText}</span>
                </div>` : ''}
              ${hasCapAny ? `<div style="display:flex;gap:6px;justify-content:flex-end;align-items:center;margin-top:2px;">
                  <span class="ico" style="display:inline-flex;line-height:0;">${svgUsers}</span>
                  <span>${capText}</span>
                </div>` : ''}
            </div>
          </div>
      
          <div class="btns">
            ${mediaArr.length ? `<button class="btn venue-media">–ú–µ–¥–∏–∞</button>` : ''}
            ${mapHref ? `<button class="btn venue-map" data-href="${mapHref}">–ö–∞—Ä—Ç–∞</button>` : ''}
          </div>
        </div>
      `;
    }

    function renderSingerCard(s) {
      const coverUrl = (Array.isArray(s.media?.photos) && s.media.photos.length) ? s.media.photos[0] : null;
      
      const svgPin = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 22s7-5.33 7-12a7 7 0 10-14 0c0 6.67 7 12 7 12z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.7" fill="none"/>
      </svg>`;
      const svgMoney = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M3 7h18v10H3z" stroke="currentColor" stroke-width="1.7" fill="none"/>
        <path d="M7 12h10M12 9v6" stroke="currentColor" stroke-width="1.7" />
      </svg>`;
      const svgMic = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <rect x="9" y="2" width="6" height="11" rx="3" stroke="currentColor" stroke-width="1.7"/>
        <path d="M5 10v2a7 7 0 0014 0v-2M12 19v3M8 22h8" stroke="currentColor" stroke-width="1.7"/>
      </svg>`;
      const svgGlobe = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.7"/>
        <path d="M2 12h20M12 2a15 15 0 010 20M12 2a15 15 0 000 20" stroke="currentColor" stroke-width="1.7"/>
      </svg>`;
      
      const {min: pMin, max: pMax} = getSingerPrice(s);
      const hasPMin = !Number.isNaN(pMin);
      const hasPMax = !Number.isNaN(pMax);
      const hasPriceAny = hasPMin || hasPMax;
      const currency = s.pricing_packages?.[0]?.currency || 'AZN';
      const priceText = hasPriceAny
        ? (hasPMin && hasPMax ? `${fmt(pMin)}‚Äì${fmt(pMax)} ${currency}`
           : hasPMin ? `–æ—Ç ${fmt(pMin)} ${currency}`
           : `–¥–æ ${fmt(pMax)} ${currency}`)
        : '';
      
      const genderLabel = getGenderLabel(s.gender);
      const genresText = Array.isArray(s.genres) && s.genres.length ? s.genres.slice(0, 3).join(', ') : '';
      const langsText = Array.isArray(s.languages) && s.languages.length ? s.languages.map(l => l.toUpperCase()).join(', ') : '';
      const regionsText = Array.isArray(s.regions_covered) && s.regions_covered.length ? s.regions_covered.slice(0, 3).join(', ') : '';
      const repCount = Array.isArray(s.repertoire) ? s.repertoire.length : 0;
      
      return `
        ${coverUrl ? `<img class="img singer-cover" src="${coverUrl}" alt="${s.name||''}" loading="lazy">` : `<div class="img singer-cover"></div>`}
        <div class="body">
          <div style="margin-bottom:8px">
            <div style="font-weight:600;font-size:18px">${s.name||''}</div>
            ${s.aliases?.length ? `<div style="font-size:13px;color:#9ca3af">${s.aliases.join(', ')}</div>` : ''}
          </div>
          
          <div style="font-size:14px;color:#64748b;display:grid;gap:4px;margin-bottom:10px">
            ${s.city ? `<div style="display:flex;align-items:center;gap:6px;">
              <span style="display:inline-flex;line-height:0;">${svgPin}</span>
              <span>${s.city}${regionsText ? ' ‚Ä¢ ' + regionsText : ''}</span>
            </div>` : ''}
            ${genresText ? `<div style="display:flex;align-items:center;gap:6px;">
              <span style="display:inline-flex;line-height:0;">${svgMic}</span>
              <span>${genresText}</span>
            </div>` : ''}
            ${langsText ? `<div style="display:flex;align-items:center;gap:6px;">
              <span style="display:inline-flex;line-height:0;">${svgGlobe}</span>
              <span>${langsText}</span>
            </div>` : ''}
          </div>
          
          ${hasPriceAny ? `<div style="display:flex;align-items:center;gap:6px;font-size:18px;font-weight:700;color:#2563eb;margin-bottom:10px">
            <span style="display:inline-flex;line-height:0;">${svgMoney}</span>
            <span>${priceText}</span>
          </div>` : ''}
          
          <div class="btns">
            ${(s.media?.photos?.length || s.media?.videos?.length) ? `<button class="btn singer-media">–ú–µ–¥–∏–∞</button>` : ''}
            ${repCount > 0 ? `<button class="btn singer-repertoire">–†–µ–ø–µ—Ä—Ç—É–∞—Ä (${repCount})</button>` : ''}
            ${s.pricing_packages?.length ? `<button class="btn singer-packages">–ü–∞–∫–µ—Ç—ã</button>` : ''}
            ${(s.phones?.length || s.contact_public) ? `<button class="btn singer-contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</button>` : ''}
          </div>
        </div>
      `;
    }

    function bindVenueCardActions(card, v) {
      const mediaArr = normalizeMedia(v.media);
      const allPhotoUrls = Array.isArray(v.media?.photos) ? v.media.photos.filter(Boolean) : [];
      const fallbackUrls = mediaArr.map(m => m?.url).filter(Boolean);
      const allMediaUrls = Array.from(new Set([...allPhotoUrls, ...fallbackUrls]));
      
      const mediaBtn = card.querySelector('.venue-media');
      mediaBtn?.addEventListener('click', () => openGallery(allMediaUrls, 0));
      
      const mapBtn = card.querySelector('.venue-map');
      mapBtn?.addEventListener('click', () => {
        const href = mapBtn.dataset.href;
        if (href) window.open(href, '_blank', 'noopener,noreferrer');
      });
      
      const coverEl = card.querySelector('.venue-cover');
      coverEl?.addEventListener('click', () => {
        if (pickMode) return;
        if (allMediaUrls.length) openGallery(allMediaUrls, 0);
      });
      coverEl && (coverEl.style.cursor = pickMode ? 'pointer' : (allMediaUrls.length ? 'zoom-in' : 'default'));
    }

    function bindSingerCardActions(card, s) {
      const allPhotoUrls = Array.isArray(s.media?.photos) ? s.media.photos.filter(Boolean) : [];
      const allVideoUrls = Array.isArray(s.media?.videos) ? s.media.videos.filter(Boolean) : [];
      const allMediaUrls = [...allPhotoUrls, ...allVideoUrls];
      
      card.querySelector('.singer-media')?.addEventListener('click', () => openGallery(allPhotoUrls, 0));
      card.querySelector('.singer-repertoire')?.addEventListener('click', () => openRepertoireModal(s));
      card.querySelector('.singer-packages')?.addEventListener('click', () => openPackagesModal(s));
      card.querySelector('.singer-contacts')?.addEventListener('click', () => openContactsModal(s));
      
      const coverEl = card.querySelector('.singer-cover');
      coverEl?.addEventListener('click', () => {
        if (pickMode) return;
        if (allPhotoUrls.length) openGallery(allPhotoUrls, 0);
      });
      coverEl && (coverEl.style.cursor = pickMode ? 'pointer' : (allPhotoUrls.length ? 'zoom-in' : 'default'));
    }

    // ---- –†–ï–ù–î–ï–† –∫–∞—Ä—Ç–æ—á–µ–∫
    function render(items, meta){
      window.__lastVenues = items;
      window.__lastMeta   = meta || null;

      $grid.innerHTML = '';
      $status.innerHTML = '';
      if (meta?.note || meta?.expires_at) {
        const note = document.createElement('div');
        note.className = 'note';
        note.textContent = `${meta?.note ? '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: '+meta.note+'. ' : ''}${meta?.expires_at ? '–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ '+new Date(meta.expires_at).toLocaleString() : ''}`;
        $status.appendChild(note);
      }
      if (!items.length) { $empty.style.display='block'; return; }
      $empty.style.display='none';

      for (const item of items) {
        let cardHtml = '';
        
        if (activeCatalog === 'venues') {
          cardHtml = renderVenueCard(item);
        } else if (activeCatalog === 'singers') {
          cardHtml = renderSingerCard(item);
        }
        
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = cardHtml;

        // –≤—ã–±–æ—Ä
        if (pickMode) {
          const dot = document.createElement('div');
          dot.className = 'select-dot';
          dot.textContent = selected.has(item.id) ? '‚úì' : '';
          dot.addEventListener('click', (e)=>{
            e.stopPropagation();
            if (selected.has(item.id)) selected.delete(item.id); else selected.add(item.id);
            dot.textContent = selected.has(item.id) ? '‚úì' : '';
            card.classList.toggle('sel', selected.has(item.id));
            $selCount.textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + selected.size;
            $genBtn.disabled = selected.size === 0;
          });
          const wrap = document.createElement('div');
          wrap.className = 'card-wrap';
          wrap.appendChild(card);
          wrap.appendChild(dot);
          $grid.appendChild(wrap);
        } else {
          $grid.appendChild(card);
        }

        // Bind card actions
        if (activeCatalog === 'venues') {
          bindVenueCardActions(card, item);
        } else if (activeCatalog === 'singers') {
          bindSingerCardActions(card, item);
        }

        // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        card.classList.toggle('sel', selected.has(item.id));
      }
    }

    // ---- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
    async function loadCatalogData(catalog) {
      const config = CATALOG_CONFIG[catalog];
      if (!config) return;
      
      $status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase‚Ä¶';
      const collectionName = COL[config.collection];
      console.log(`Loading catalog: ${catalog}, collection: ${collectionName}`);
      
      const snap = await getDocs(collection(db, collectionName));
      const items = [];
      snap.forEach(d => {
        const data = d.data();
        // –î–ª—è –ø–µ–≤—Ü–æ–≤ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ published
        if (catalog === 'singers' && data.status !== 'published') {
          console.log(`Skipping singer ${d.id}: status = ${data.status}`);
          return;
        }
        items.push({ id: d.id, ...data });
      });
      
      console.log(`Loaded ${items.length} items for catalog ${catalog}`);
      $status.textContent = items.length === 0 ? `–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∫–∞—Ç–∞–ª–æ–≥–µ ${config.title}` : '';

      // –í–ê–ñ–ù–û: –≤—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º _allVenues, –¥–∞–∂–µ –µ—Å–ª–∏ items –ø—É—Å—Ç–æ–π
      _allVenues = items.slice();
      _viewVenues = [];
      
      // Populate dynamic filters
      if (catalog === 'venues') {
        populateDistricts(_allVenues);
      } else if (catalog === 'singers') {
        populateCities(_allVenues);
        populateGenres(_allVenues);
        populateLanguages(_allVenues);
      }
      
      restoreFiltersFromURL();
      bindFilterEventsOnce();
      applyFilters();
    }

    async function loadShortlist(catalog, slug, token) {
      const config = CATALOG_CONFIG[catalog];
      if (!config) return;
      
      $status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —à–æ—Ä—Ç–ª–∏—Å—Ç–∞‚Ä¶';
      const sDoc = await getDoc(doc(db, COL[config.shortlistCollection], slug));
      if (!sDoc.exists()) { $status.textContent = '–®–æ—Ä—Ç–ª–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'; return; }
      const sData = sDoc.data();
      
      // Check token
      if (sData.token && sData.token !== token) { $status.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'; return; }
      if (sData.token_hash) {
        const h = await sha256Hex(token || '');
        if (h !== sData.token_hash) { $status.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'; return; }
      }
      
      // Check expiration
      const exp = sData.expires_at?.toDate ? sData.expires_at.toDate() : (sData.expires_at ? new Date(sData.expires_at) : null);
      if (exp && exp < new Date()) { $status.textContent = '–°—Å—ã–ª–∫–∞ –∏—Å—Ç–µ–∫–ª–∞'; return; }

      // Load items by IDs
      const ids = catalog === 'singers' ? (sData.singer_ids || []) : (sData.venue_ids || []);
      const items = [];
      for (const id of ids) {
        const itemDoc = await getDoc(doc(db, COL[config.collection], id));
        if (itemDoc.exists()) {
          const data = itemDoc.data();
          // –î–ª—è –ø–µ–≤—Ü–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º status
          if (catalog === 'singers' && data.status !== 'published') continue;
          items.push({ id: itemDoc.id, ...data });
        }
      }
      $status.textContent = '';

      _allVenues = items.slice();
      
      // Populate dynamic filters
      if (catalog === 'venues') {
        populateDistricts(_allVenues);
      } else if (catalog === 'singers') {
        populateCities(_allVenues);
        populateGenres(_allVenues);
        populateLanguages(_allVenues);
      }
      
      restoreFiltersFromURL();
      bindFilterEventsOnce();
      applyFilters();
    }

    // ---- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ (—á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫)
    $genBtn?.addEventListener('click', () => {
      if (!selected.size) return;
      $cfgExpire.value = '7';
      $cfgDateWrap.style.display = 'none';
      $cfgSlug.value = '';
      $cfgNote.value = '–ü–æ–¥–±–æ—Ä –æ—Ç ' + new Date().toLocaleString();
      openCfg();
    });

    $cfgCreate?.addEventListener('click', async () => {
      if (!selected.size) return;
      let slug = ($cfgSlug.value || '').trim().toLowerCase();
      if (!slug) slug = Math.random().toString(36).slice(2,8);
      if (!/^[a-z0-9-]{3,50}$/.test(slug)) { alert('Slug: –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/–¥–µ—Ñ–∏—Å—ã (3‚Äì50).'); return; }

      let expiresAt;
      if ($cfgExpire.value === 'custom') {
        if (!$cfgDate.value) { alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É/–≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è.'); return; }
        expiresAt = new Date($cfgDate.value);
      } else {
        const days = parseInt($cfgExpire.value, 10) || 7;
        expiresAt = new Date(Date.now() + days*24*60*60*1000);
      }

      const ids   = Array.from(selected);
      const token = Math.random().toString(36).slice(2,10);
      const note  = $cfgNote.value?.trim() || null;
      
      const config = CATALOG_CONFIG[activeCatalog];
      const idField = activeCatalog === 'singers' ? 'singer_ids' : 'venue_ids';

      try {
        const docData = {
          [idField]: ids,
          token_hash: await sha256Hex(token),
          note,
          created_at: serverTimestamp(),
          expires_at: expiresAt
        };
        
        await setDoc(doc(db, COL[config.shortlistCollection], slug), docData);
        closeCfg();

        const params = new URLSearchParams();
        params.set('catalog', activeCatalog);
        params.set('shortlist', slug);
        params.set('token', token);
        const url = `${location.origin}/?${params.toString()}`;
        
        lastGeneratedUrl = url;
        ($shareBox || {}).style.display = 'inline-flex';
        const enc = encodeURIComponent(url);
        if ($waBtn) $waBtn.href = `https://wa.me/?text=${enc}`;
        if ($tgBtn) $tgBtn.href = `https://t.me/share/url?url=${enc}`;

        const copied = await copyToClipboard(url);
        if (copied) showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); else alert('–°—Å—ã–ª–∫–∞:\n' + url);
        if (navigator.share) { try { await navigator.share({ title:'–ü–æ–¥–±–æ—Ä', url }); } catch {} }
      } catch (e) {
        console.error(e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É: ' + (e?.message || e));
      }
    });

    // ---- –°—Ç–∞—Ä—Ç ‚Äî —Ä–µ—à–∞–µ–º, —á—Ç–æ –≥—Ä—É–∑–∏—Ç—å
    const qs = new URLSearchParams(location.search);
    const catalogParam = qs.get('catalog') || 'venues';
    const shortlistSlug  = qs.get('shortlist');
    const shortlistToken = qs.get('token');
    
    // Set active catalog
    activeCatalog = CATALOG_CONFIG[catalogParam] ? catalogParam : 'venues';
    
    // Initialize UI
    document.querySelectorAll('.catalog-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.catalog === activeCatalog);
    });
    $pageTitle.textContent = CATALOG_CONFIG[activeCatalog].title;
    buildFilters(activeCatalog);
    
    try {
      if (shortlistSlug && shortlistToken) {
        await loadShortlist(activeCatalog, shortlistSlug, shortlistToken);
      } else {
        await loadCatalogData(activeCatalog);
      }
    } catch (e) {
      console.error(e);
      $status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e?.message || e);
    }
  });
</script>
</body>
</html>
